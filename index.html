<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Madani Exp Tracker</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fab-shadow { box-shadow: 0 4px 15px rgba(13, 148, 136, 0.4); }
        .nav-item.active { color: #0d9488; }
        .nav-item { color: #94a3b8; transition: color 0.3s; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        select { -webkit-appearance: none; appearance: none; }
        #guest-container { display: none; }
        /* Progress bar animation */
        .progress-bar { transition: width 1s ease-in-out; }
    </style>
</head>
<body class="text-slate-800 bg-slate-50">

    <!-- === GUEST VIEW === -->
    <div id="guest-container" class="w-full max-w-md mx-auto min-h-screen bg-white p-6 flex flex-col items-center justify-center text-center fade-in">
        <div class="w-20 h-20 bg-teal-50 rounded-full flex items-center justify-center mb-6 shadow-sm border border-teal-100">
            <i class="fas fa-file-invoice-dollar text-3xl text-teal-600"></i>
        </div>
        <h1 class="text-2xl font-bold text-slate-800 mb-1">Madani Exp Tracker</h1>
        <p class="text-xs text-teal-600 font-semibold mb-8 tracking-widest uppercase">Junaid Madani</p>
        <div class="w-full bg-slate-50 p-8 rounded-3xl border border-slate-200 mb-6 shadow-sm">
            <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Account Name</p>
            <h2 class="text-2xl font-bold text-slate-800 mb-6" id="guest-name">---</h2>
            <div class="w-full border-t border-dashed border-slate-300 mb-6"></div>
            <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Total Pending Balance</p>
            <h1 class="text-5xl font-black text-rose-600" id="guest-balance">₹0</h1>
        </div>
        <div class="p-4 w-full flex-1 overflow-y-auto">
             <h3 class="font-bold text-left text-sm mb-3">History</h3>
             <div id="guest-history-list" class="space-y-3"></div>
        </div>
    </div>

    <!-- === MAIN APP CONTAINER === -->
    <div id="main-container" class="w-full max-w-md mx-auto min-h-screen relative bg-white sm:shadow-xl overflow-hidden pb-[90px]">
        
        <!-- HEADER -->
        <header class="bg-white p-4 sticky top-0 z-30 shadow-sm border-b border-slate-100 flex justify-between items-center">
            <div>
                <h1 class="text-lg font-bold text-teal-700 flex items-center gap-2"><i class="fas fa-wallet"></i> Madani Exp Tracker</h1>
                <p class="text-[10px] text-teal-600 font-bold ml-7 -mt-1 tracking-wide">Junaid Madani</p>
            </div>
            <div class="flex items-center gap-3">
                <div class="text-right">
                    <p class="text-[10px] text-slate-400 uppercase tracking-wider font-bold">Net Worth</p>
                    <h2 class="text-xl font-bold text-slate-800" id="total-balance">₹0</h2>
                </div>
                <!-- Settings Button (ID added just in case, but logic handles if missing) -->
                <button onclick="switchView('settings')" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 hover:bg-slate-100 flex items-center justify-center"><i class="fas fa-cog"></i></button>
            </div>
        </header>

        <!-- === 1. HOME VIEW === -->
        <section id="view-home" class="p-4 fade-in block pb-24">
            <div class="grid grid-cols-3 gap-3 mb-5">
                <div class="bg-blue-50 p-3 rounded-xl border border-blue-100 text-center"><p class="text-[10px] text-slate-500 uppercase font-bold">Cash</p><p class="text-sm font-bold text-slate-800" id="cash-balance">₹0</p></div>
                <div class="bg-indigo-50 p-3 rounded-xl border border-indigo-100 text-center"><p class="text-[10px] text-slate-500 uppercase font-bold">Bank</p><p class="text-sm font-bold text-slate-800" id="bank-balance">₹0</p></div>
                <div class="bg-orange-50 p-3 rounded-xl border border-orange-100 text-center relative"><p class="text-[10px] text-slate-500 uppercase font-bold">Udhar</p><p class="text-sm font-bold text-orange-600" id="udhar-balance">₹0</p></div>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-6">
                <div onclick="showSummary('income')" class="cursor-pointer bg-emerald-50 p-4 rounded-xl border border-emerald-100 flex justify-between items-center active:scale-95 transition-transform"><div><p class="text-[10px] text-emerald-600 font-bold uppercase">Income</p><p class="text-lg font-bold text-emerald-700" id="total-income">₹0</p></div><div class="bg-emerald-200/50 w-8 h-8 rounded-full flex items-center justify-center text-emerald-700"><i class="fas fa-arrow-down"></i></div></div>
                <div onclick="showSummary('expense')" class="cursor-pointer bg-rose-50 p-4 rounded-xl border border-rose-100 flex justify-between items-center active:scale-95 transition-transform"><div><p class="text-[10px] text-rose-600 font-bold uppercase">Expense</p><p class="text-lg font-bold text-rose-700" id="total-expense">₹0</p></div><div class="bg-rose-200/50 w-8 h-8 rounded-full flex items-center justify-center text-rose-700"><i class="fas fa-arrow-up"></i></div></div>
            </div>

            <h3 class="font-bold text-slate-700 text-sm mb-3">Expense Analysis</h3>
            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100 mb-4">
                <div class="flex justify-center mb-6 relative">
                    <div class="h-48 w-48 relative z-10"><canvas id="expenseChart"></canvas></div>
                    <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none"><p class="text-[10px] text-slate-400 uppercase font-bold">Total</p><p class="text-lg font-bold text-slate-800" id="chart-total-center">₹0</p></div>
                </div>
                <div id="analysis-legend" class="space-y-3"></div>
            </div>
        </section>

        <!-- === 2. REPORT VIEW === -->
        <section id="view-report" class="p-4 fade-in hidden pb-24">
            <h2 class="text-lg font-bold mb-4">Reports & History</h2>
            <div class="bg-slate-50 p-3 rounded-xl border border-slate-200 mb-4">
                <div class="flex gap-2 mb-3">
                    <select id="filter-type" class="w-1/3 p-2 text-xs rounded-lg border border-slate-300"><option value="month">Monthly</option><option value="year">Yearly</option><option value="custom">Custom</option><option value="all">All Time</option></select>
                    <input type="month" id="filter-month-input" class="w-2/3 p-2 text-xs rounded-lg border border-slate-300">
                    <select id="filter-year-input" class="hidden w-2/3 p-2 text-xs rounded-lg border border-slate-300"></select>
                </div>
                <div id="custom-date-range" class="hidden flex gap-2 mb-3"><input type="date" id="filter-start-date" class="w-1/2 p-2 text-xs rounded-lg border border-slate-300"><input type="date" id="filter-end-date" class="w-1/2 p-2 text-xs rounded-lg border border-slate-300"></div>
                
                <!-- Type Filters -->
                <div class="flex bg-slate-200 p-1 rounded-lg">
                    <button onclick="setReportFilter('all')" id="btn-rep-all" class="flex-1 py-1.5 rounded-md text-[10px] font-bold bg-white shadow-sm text-slate-800">All</button>
                    <button onclick="setReportFilter('expense')" id="btn-rep-exp" class="flex-1 py-1.5 rounded-md text-[10px] font-bold text-slate-500 hover:text-slate-700">Debit (Exp)</button>
                    <button onclick="setReportFilter('income')" id="btn-rep-inc" class="flex-1 py-1.5 rounded-md text-[10px] font-bold text-slate-500 hover:text-slate-700">Credit (Inc)</button>
                </div>
            </div>
            
            <button onclick="downloadPDF()" class="w-full mb-4 bg-slate-800 text-white py-2.5 rounded-lg text-xs font-bold shadow-lg flex items-center justify-center gap-2 active:scale-95"><i class="fas fa-file-pdf"></i> Download PDF Report</button>
            
            <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden"><ul id="full-list" class="divide-y divide-slate-50"></ul></div>
        </section>

        <!-- === 3. BUDGET VIEW === -->
        <section id="view-budget" class="p-4 fade-in hidden pb-24">
            <h2 class="text-lg font-bold mb-4">Budget Plan (50/30/20)</h2>
            
            <div class="bg-teal-50 p-4 rounded-xl border border-teal-100 mb-6">
                <label class="block text-[10px] font-bold text-teal-700 uppercase mb-2">Monthly Salary / Income</label>
                <div class="flex gap-2">
                    <input type="number" id="budget-salary" placeholder="Enter Amount" class="flex-1 p-2 border border-teal-200 rounded-lg font-bold text-slate-700 focus:outline-none">
                    <button onclick="saveBudget()" class="bg-teal-600 text-white px-4 py-2 rounded-lg text-xs font-bold">Set</button>
                </div>
            </div>

            <div id="budget-cards" class="space-y-4">
                <!-- Needs -->
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                    <div class="flex justify-between items-end mb-2">
                        <div>
                            <h4 class="font-bold text-slate-800">Needs (50%)</h4>
                            <p class="text-[10px] text-slate-400">Food, Utilities, Medical, Transport...</p>
                        </div>
                        <span id="needs-limit" class="text-xs font-bold text-slate-500">Target: ₹0</span>
                    </div>
                    <div class="w-full bg-slate-100 rounded-full h-2.5 mb-1 overflow-hidden">
                        <div id="needs-bar" class="bg-blue-500 h-2.5 rounded-full progress-bar" style="width: 0%"></div>
                    </div>
                    <div class="flex justify-between text-[10px] font-bold">
                        <span id="needs-spent" class="text-blue-600">Spent: ₹0</span>
                        <span id="needs-status" class="text-slate-400">Safe</span>
                    </div>
                </div>

                <!-- Wants -->
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                    <div class="flex justify-between items-end mb-2">
                        <div>
                            <h4 class="font-bold text-slate-800">Wants (30%)</h4>
                            <p class="text-[10px] text-slate-400">Shopping, Eating Out, Travel...</p>
                        </div>
                        <span id="wants-limit" class="text-xs font-bold text-slate-500">Target: ₹0</span>
                    </div>
                    <div class="w-full bg-slate-100 rounded-full h-2.5 mb-1 overflow-hidden">
                        <div id="wants-bar" class="bg-purple-500 h-2.5 rounded-full progress-bar" style="width: 0%"></div>
                    </div>
                    <div class="flex justify-between text-[10px] font-bold">
                        <span id="wants-spent" class="text-purple-600">Spent: ₹0</span>
                        <span id="wants-status" class="text-slate-400">Safe</span>
                    </div>
                </div>

                <!-- Savings -->
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                    <div class="flex justify-between items-end mb-2">
                        <div>
                            <h4 class="font-bold text-slate-800">Savings (20%)</h4>
                            <p class="text-[10px] text-slate-400">Investments, Emergency Fund...</p>
                        </div>
                        <span id="savings-limit" class="text-xs font-bold text-slate-500">Target: ₹0</span>
                    </div>
                    <div class="w-full bg-slate-100 rounded-full h-2.5 mb-1 overflow-hidden">
                        <div id="savings-bar" class="bg-emerald-500 h-2.5 rounded-full progress-bar" style="width: 0%"></div>
                    </div>
                    <div class="flex justify-between text-[10px] font-bold">
                        <span id="savings-saved" class="text-emerald-600">Saved: ₹0</span>
                        <span id="savings-status" class="text-slate-400">On Track</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- === 4. UDHAR VIEW === -->
        <section id="view-udhar" class="p-4 fade-in hidden pb-24">
            <div class="flex justify-between items-center mb-4"><h2 class="text-lg font-bold text-slate-800">Udhar Manager</h2></div>
            <div class="bg-orange-50 p-5 rounded-xl border border-orange-100 mb-4 text-center">
                <p class="text-xs text-orange-800 uppercase font-bold tracking-wider mb-1">Total Udhar Market Mein</p>
                <h1 class="text-3xl font-bold text-orange-600" id="udhar-total-display">₹0</h1>
                <button onclick="openNewUdharModal()" class="mt-4 w-full bg-orange-600 text-white py-3 rounded-xl text-xs font-bold flex items-center justify-center gap-2 active:scale-95 shadow-md"><i class="fas fa-exchange-alt"></i> Naya Udhar (Len / Den)</button>
            </div>
            <h3 class="font-bold text-slate-700 text-sm mb-3">Accounts</h3>
            <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden" id="udhar-list-container">
                <ul id="udhar-list" class="divide-y divide-slate-50"></ul>
            </div>
            <p id="no-udhar-msg" class="text-center text-slate-400 text-xs py-10 hidden">No active accounts.</p>
        </section>

        <!-- === 5. SETTINGS VIEW === -->
        <section id="view-settings" class="p-4 fade-in hidden pb-24">
            <h2 class="text-lg font-bold mb-4">Settings</h2>
            <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                <button onclick="exportData()" class="w-full text-left p-4 hover:bg-slate-50 flex items-center gap-3 border-b border-slate-50"><div class="w-8 h-8 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center"><i class="fas fa-save"></i></div><div><p class="text-sm font-bold text-slate-700">Backup Data</p><p class="text-[10px] text-slate-400">Save to device</p></div></button>
                <button onclick="triggerRestore()" class="w-full text-left p-4 hover:bg-slate-50 flex items-center gap-3 border-b border-slate-50"><div class="w-8 h-8 rounded-full bg-green-50 text-green-600 flex items-center justify-center"><i class="fas fa-file-import"></i></div><div><p class="text-sm font-bold text-slate-700">Restore Data</p><p class="text-[10px] text-slate-400">Import backup file</p></div></button>
                <input type="file" id="import-file" class="hidden" accept=".json" onchange="processImport(this)">
                <button onclick="clearAll()" class="w-full text-left p-4 hover:bg-red-50 flex items-center gap-3 border-b border-slate-50"><div class="w-8 h-8 rounded-full bg-red-50 text-red-600 flex items-center justify-center"><i class="fas fa-trash-alt"></i></div><div><p class="text-sm font-bold text-red-600">Reset App</p><p class="text-[10px] text-red-400">Delete all data</p></div></button>
                <button onclick="exitApp()" class="w-full text-left p-4 hover:bg-slate-50 flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center"><i class="fas fa-power-off"></i></div><div><p class="text-sm font-bold text-slate-700">Exit App</p><p class="text-[10px] text-slate-400">Close application</p></div></button>
            </div>
            <p class="text-center text-[10px] text-slate-300 mt-8 font-semibold tracking-wide">Madani Exp Tracker v6.0</p>
        </section>

        <!-- NAV -->
        <nav class="fixed bottom-0 w-full max-w-md bg-white border-t border-slate-100 flex justify-between items-end px-6 pb-2 pt-2 z-40 shadow-lg" style="left: 50%; transform: translateX(-50%);">
            <button onclick="switchView('home')" class="nav-item active flex flex-col items-center gap-1" id="nav-home"><i class="fas fa-home text-lg"></i><span class="text-[9px] font-bold">Home</span></button>
            <button onclick="switchView('report')" class="nav-item flex flex-col items-center gap-1" id="nav-report"><i class="fas fa-chart-pie text-lg"></i><span class="text-[9px] font-bold">Report</span></button>
            <div class="relative w-12 flex justify-center z-50"><button onclick="openEntryModal()" class="absolute -top-10 bg-teal-600 text-white w-14 h-14 rounded-full flex items-center justify-center text-2xl fab-shadow transition-transform active:scale-90 border-[4px] border-slate-50 shadow-lg shadow-teal-100"><i class="fas fa-plus"></i></button></div>
            <button onclick="switchView('budget')" class="nav-item flex flex-col items-center gap-1" id="nav-budget"><i class="fas fa-wallet text-lg"></i><span class="text-[9px] font-bold">Budget</span></button>
            <button onclick="switchView('udhar')" class="nav-item flex flex-col items-center gap-1" id="nav-udhar"><i class="fas fa-hand-holding-usd text-lg"></i><span class="text-[9px] font-bold">Udhar</span></button>
        </nav>
    </div>

    <!-- ENTRY MODAL -->
    <div id="entry-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-end justify-center sm:items-center p-0 sm:p-4 fade-in"><div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl"><div class="flex justify-between items-center mb-6"><h3 class="font-bold text-lg text-slate-800" id="entry-modal-title">New Entry</h3><button onclick="closeEntryModal()" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 flex items-center justify-center"><i class="fas fa-times"></i></button></div><div class="space-y-4"><div class="bg-slate-100 p-1 rounded-xl flex font-bold text-xs" id="type-tabs-wrapper"><button onclick="setTxType('expense')" id="btn-expense" class="flex-1 py-3 rounded-lg shadow-sm bg-white text-rose-600">Expense</button><button onclick="setTxType('income')" id="btn-income" class="flex-1 py-3 rounded-lg text-slate-400">Income</button></div><input type="hidden" id="tx-type" value="expense"><div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Amount</label><input type="number" id="tx-amount" placeholder="0" class="w-full pl-4 p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-xl text-slate-800 focus:outline-none focus:border-teal-500"></div><div class="grid grid-cols-2 gap-3"><div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Category</label><select id="tx-category" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold text-slate-700 outline-none focus:border-teal-500"></select></div><div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Wallet</label><select id="tx-account" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold text-slate-700 outline-none focus:border-teal-500"><option value="Cash">Cash</option><option value="Bank">Bank Account</option></select></div></div><div class="grid grid-cols-2 gap-3"><div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Date</label><div class="flex gap-2"><input type="date" id="tx-date" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold outline-none"><button onclick="setTodayDate('tx-date')" class="bg-teal-100 text-teal-700 px-3 rounded-lg text-xs font-bold active:scale-95">Today</button></div></div><div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Note</label><input type="text" id="tx-note" placeholder="Details..." class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold outline-none"></div></div><button onclick="saveTransaction()" class="w-full bg-teal-600 text-white font-bold py-3.5 rounded-xl shadow-lg active:scale-95 flex justify-center items-center gap-2 mt-2"><i class="fas fa-check"></i> <span id="save-btn-text">Save Transaction</span></button></div></div></div>

    <!-- UDHAR MODAL -->
    <div id="udhar-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-end justify-center sm:items-center p-0 sm:p-4 fade-in"><div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl"><div class="flex justify-between items-center mb-6"><h3 class="font-bold text-lg text-slate-800" id="udhar-modal-title">New Udhar Entry</h3><button onclick="closeUdharModal()" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 flex items-center justify-center"><i class="fas fa-times"></i></button></div><div class="space-y-4">
    <!-- Udhar Type Switch -->
    <div class="bg-slate-100 p-1 rounded-xl flex font-bold text-xs mb-3"><button onclick="setUdharType('given')" id="btn-u-given" class="flex-1 py-3 rounded-lg shadow-sm bg-white text-orange-600">Maine Diya (Given)</button><button onclick="setUdharType('taken')" id="btn-u-taken" class="flex-1 py-3 rounded-lg text-slate-400">Maine Liya (Taken)</button></div><input type="hidden" id="udhar-type-val" value="given">
    <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Amount</label><input type="number" id="udhar-amount" placeholder="0" class="w-full pl-4 p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-xl text-slate-800 focus:outline-none focus:border-orange-500"></div><button onclick="pickContact()" class="w-full py-3 bg-orange-50 border border-dashed border-orange-200 rounded-xl text-orange-600 font-bold text-xs flex items-center justify-center gap-2 hover:bg-orange-100"><i class="fas fa-address-book text-lg"></i> Select from Contacts</button><div><label class="block text-[10px] font-bold text-orange-700 uppercase mb-1 ml-1">Person Name</label><input type="text" id="udhar-person" list="udhar-names-list" placeholder="Enter Name" class="w-full p-3 bg-white border border-orange-200 rounded-xl text-sm font-semibold text-slate-700 outline-none focus:border-orange-500"><datalist id="udhar-names-list"></datalist></div><div class="grid grid-cols-2 gap-3"><div><label class="block text-[10px] font-bold text-orange-700 uppercase mb-1 ml-1">Mobile (WA)</label><input type="tel" id="udhar-phone" placeholder="91..." class="w-full p-3 bg-white border border-orange-200 rounded-xl text-sm font-semibold text-slate-700 outline-none focus:border-orange-500"></div><div><label class="block text-[10px] font-bold text-orange-700 uppercase mb-1 ml-1" id="wallet-label">From Wallet</label><select id="udhar-source" class="w-full p-3 bg-white border border-orange-200 rounded-xl text-sm font-semibold text-slate-700 outline-none focus:border-orange-500"><option value="Cash">Cash</option><option value="Bank">Bank Account</option></select></div></div><div class="grid grid-cols-2 gap-3"><div><label class="block text-[10px] font-bold text-orange-700 uppercase mb-1 ml-1">Date</label><input type="date" id="udhar-date" class="w-full p-3 bg-white border border-orange-200 rounded-xl text-xs font-semibold text-slate-700 outline-none"></div><div><label class="block text-[10px] font-bold text-orange-700 uppercase mb-1 ml-1">Due Date</label><input type="date" id="udhar-return-date" class="w-full p-3 bg-white border border-orange-200 rounded-xl text-xs font-semibold text-slate-700 outline-none"></div></div><button onclick="saveUdharTransaction()" class="w-full bg-orange-600 text-white font-bold py-3.5 rounded-xl shadow-lg hover:bg-orange-700 active:scale-95 flex justify-center items-center gap-2 mt-2"><i class="fas fa-save"></i> <span id="save-udhar-btn-text">Save Loan Record</span></button></div></div></div>

    <!-- UTILITY MODALS -->
    <div id="summary-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4 fade-in"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2"><h3 class="font-bold text-lg text-slate-800" id="summary-title">Summary</h3><button onclick="document.getElementById('summary-modal').classList.add('hidden')" class="w-8 h-8 rounded-full bg-slate-100 text-slate-400 hover:bg-slate-200 flex items-center justify-center"><i class="fas fa-times"></i></button></div><div id="summary-content" class="space-y-3 max-h-96 overflow-y-auto no-scrollbar"></div></div></div>
    
    <!-- RESTORE CONFIRM MODAL -->
    <div id="restore-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4 fade-in"><div class="bg-white w-full max-w-xs rounded-2xl p-5 shadow-2xl text-center"><h3 class="font-bold text-lg text-slate-800 mb-2">Restore Backup</h3><p class="text-xs text-slate-500 mb-4">How do you want to restore data?</p><div class="flex flex-col gap-2"><button onclick="confirmRestore('merge')" class="w-full py-3 bg-blue-50 text-blue-600 rounded-xl text-xs font-bold border border-blue-100">Merge (Keep Existing)</button><button onclick="confirmRestore('replace')" class="w-full py-3 bg-red-50 text-red-600 rounded-xl text-xs font-bold border border-red-100">Replace (Clear Existing)</button><button onclick="document.getElementById('restore-modal').classList.add('hidden')" class="w-full py-3 text-slate-400 text-xs font-bold">Cancel</button></div></div></div>

    <!-- WUSOOL MODAL -->
    <div id="wusool-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4 fade-in"><div class="bg-white w-full max-w-xs rounded-2xl p-5 shadow-2xl"><div class="flex justify-between items-center mb-4 border-b border-slate-50 pb-2"><h3 class="font-bold text-lg text-slate-800" id="wusool-modal-title">Receive Money</h3><button onclick="document.getElementById('wusool-modal').classList.add('hidden')" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 flex items-center justify-center"><i class="fas fa-times"></i></button></div><p class="text-xs text-slate-500 mb-2 font-bold" id="wusool-msg">Settling...</p><input type="hidden" id="wusool-person-name"><label class="block text-[10px] font-bold text-emerald-600 uppercase mb-2 ml-1">Received Amount</label><div class="flex gap-2 mb-3"><input type="number" id="wusool-amount" class="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg text-lg font-bold text-slate-800 focus:outline-none focus:border-teal-500"><button onclick="settleFull()" class="bg-emerald-100 text-emerald-700 px-3 py-2 rounded-lg text-xs font-bold whitespace-nowrap active:scale-95">Full Settle</button></div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-2 ml-1">Deposit To</label><select id="wusool-account" class="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg text-sm font-semibold mb-4"><option value="Cash">Cash</option><option value="Bank">Bank Account</option></select><div class="flex gap-2"><button onclick="document.getElementById('wusool-modal').classList.add('hidden')" class="flex-1 py-2 text-slate-500 font-bold text-xs bg-slate-100 rounded-lg">Cancel</button><button onclick="confirmWusool()" class="flex-1 py-2 text-white font-bold text-xs bg-emerald-600 rounded-lg">Confirm</button></div></div></div>
    
    <!-- PERSON HISTORY MODAL (ACTION CENTER) -->
    <div id="person-history-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-end sm:items-center justify-center p-0 sm:p-4 fade-in"><div class="bg-white w-full max-w-sm rounded-t-3xl sm:rounded-3xl shadow-2xl flex flex-col max-h-[85vh]"><div class="flex justify-between items-center p-4 pb-2 border-b border-slate-50 shrink-0"><div><h3 class="font-bold text-lg text-slate-800" id="ph-name">Name</h3><p class="text-[10px] text-slate-400">Transaction History</p></div><button onclick="document.getElementById('person-history-modal').classList.add('hidden')" class="w-8 h-8 rounded-full bg-slate-100 text-slate-400 hover:bg-slate-200 flex items-center justify-center"><i class="fas fa-times"></i></button></div><div class="bg-slate-50 p-4 text-center border-b border-slate-100"><h2 id="ph-balance" class="text-3xl font-bold text-slate-800 mb-1">₹0</h2><p class="text-[10px] text-slate-400 uppercase tracking-widest font-bold">Current Balance</p></div><div class="grid grid-cols-3 gap-2 p-4 pb-0"><button id="btn-give-more" class="bg-rose-50 hover:bg-rose-100 border border-rose-100 text-rose-700 p-3 rounded-xl flex flex-col items-center gap-1 active:scale-95 transition-transform"><i class="fas fa-minus-circle text-lg"></i> <span class="text-xs font-bold">Give</span></button><button id="btn-receive-money" class="bg-emerald-50 hover:bg-emerald-100 border border-emerald-100 text-emerald-700 p-3 rounded-xl flex flex-col items-center gap-1 active:scale-95 transition-transform"><i class="fas fa-plus-circle text-lg"></i> <span class="text-xs font-bold">Receive</span></button><button id="btn-settle-all" class="bg-blue-50 hover:bg-blue-100 border border-blue-100 text-blue-700 p-3 rounded-xl flex flex-col items-center gap-1 active:scale-95 transition-transform"><i class="fas fa-check-circle text-lg"></i> <span class="text-xs font-bold">Settle</span></button></div><div class="px-4 pt-2"><button id="btn-whatsapp" class="w-full py-2.5 bg-green-50 text-green-700 border border-green-100 rounded-xl text-xs font-bold flex items-center justify-center gap-2 active:scale-95 hover:bg-green-100 transition-colors"><i class="fab fa-whatsapp text-lg"></i> Send Reminder / Statement</button></div><div class="p-4 pt-4 overflow-y-auto space-y-4 flex-1" id="ph-content"></div></div></div>
    
    <div id="contacts-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-[60] flex items-center justify-center p-4 fade-in"><div class="bg-white w-full max-w-xs rounded-2xl p-5 shadow-2xl"><div class="flex justify-between items-center mb-3 border-b border-slate-100 pb-2"><h3 class="font-bold text-slate-800">Select Contact</h3><button onclick="document.getElementById('contacts-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button></div><div id="contacts-list-content" class="space-y-2 max-h-60 overflow-y-auto no-scrollbar"></div></div></div>

    <script>
        // --- DATA & CONFIG ---
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let budgetSalary = parseFloat(localStorage.getItem('budgetSalary')) || 0;
        let chartInstance = null;
        let editingTransactionId = null;
        let lastOpenedPerson = null;
        let currentView = 'home';
        let filterState = { type: 'month', month: new Date().toISOString().slice(0,7), year: new Date().getFullYear(), start: '', end: '', reportFilter: 'all' };
        let tempImportData = null;

        // 1. Updated Categories
        const catConfig = {
            "Food & Groceries": { icon: "fa-utensils", color: "bg-orange-500", text: "text-orange-500", bgLight: "bg-orange-50", type: "needs" },
            "Utilities": { icon: "fa-bolt", color: "bg-blue-500", text: "text-blue-500", bgLight: "bg-blue-50", type: "needs" },
            "Mobile & Recharge": { icon: "fa-mobile-alt", color: "bg-cyan-500", text: "text-cyan-500", bgLight: "bg-cyan-50", type: "needs" },
            "Transportation": { icon: "fa-bus", color: "bg-yellow-500", text: "text-yellow-500", bgLight: "bg-yellow-50", type: "needs" },
            "Shopping": { icon: "fa-shopping-bag", color: "bg-purple-500", text: "text-purple-500", bgLight: "bg-purple-50", type: "wants" },
            "Medical": { icon: "fa-briefcase-medical", color: "bg-green-500", text: "text-green-500", bgLight: "bg-green-50", type: "needs" },
            "Personal Care": { icon: "fa-user-circle", color: "bg-pink-400", text: "text-pink-400", bgLight: "bg-pink-50", type: "wants" },
            "Family Shopping": { icon: "fa-shopping-bag", color: "bg-purple-500", text: "text-purple-500", bgLight: "bg-purple-50", type: "wants" },
            "Eating Out": { icon: "fa-hamburger", color: "bg-rose-400", text: "text-rose-400", bgLight: "bg-rose-50", type: "wants" },
            "EMI / Loan": { icon: "fa-university", color: "bg-red-600", text: "text-red-600", bgLight: "bg-red-50", type: "needs" },
            "Family Support": { icon: "fa-users", color: "bg-indigo-500", text: "text-indigo-500", bgLight: "bg-indigo-50", type: "savings" },
            "Donations & Charity": { icon: "fa-hand-holding-heart", color: "bg-teal-500", text: "text-teal-500", bgLight: "bg-teal-50", type: "savings" },
            "Savings & Investment": { icon: "fa-piggy-bank", color: "bg-emerald-600", text: "text-emerald-600", bgLight: "bg-emerald-50", type: "savings" },
            "Repair & Maintenance": { icon: "fa-tools", color: "bg-gray-500", text: "text-gray-500", bgLight: "bg-gray-50", type: "needs" },
            "Travel & Tour": { icon: "fa-plane", color: "bg-sky-500", text: "text-sky-500", bgLight: "bg-sky-50", type: "wants" },
            "Unexpected / Emergency": { icon: "fa-exclamation-triangle", color: "bg-red-500", text: "text-red-500", bgLight: "bg-red-50", type: "savings" },
            // Income Cats
            "Salary": { icon: "fa-money-bill", color: "bg-emerald-500", text: "text-emerald-500", bgLight: "bg-emerald-50" },
            "Business": { icon: "fa-briefcase", color: "bg-blue-600", text: "text-blue-600", bgLight: "bg-blue-50" },
            "Gift": { icon: "fa-gift", color: "bg-pink-500", text: "text-pink-500", bgLight: "bg-pink-50" },
            "Bonus": { icon: "fa-star", color: "bg-yellow-500", text: "text-yellow-500", bgLight: "bg-yellow-50" },
            "Loan Taken": { icon: "fa-hand-holding-usd", color: "bg-orange-500", text: "text-orange-500", bgLight: "bg-orange-50" }
        };
        const expenseCats = Object.keys(catConfig).filter(k => !["Salary","Business","Gift","Bonus","Loan Taken"].includes(k));
        const incomeCats = ["Salary", "Business", "Gift", "Bonus", "Loan Taken", "Other"];
        const formatter = new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0 });

        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            if(params.get('guest') === 'true') {
                document.getElementById('main-container').style.display = 'none';
                document.getElementById('guest-container').style.display = 'flex';
                document.getElementById('guest-name').innerText = decodeURIComponent(params.get('n') || 'Guest');
                document.getElementById('guest-balance').innerText = formatter.format(parseFloat(params.get('b')) || 0);
                loadGuestHistory(params.get('h'));
            } else {
                setupDates();
                initFilterUI();
                recalculateRepayments();
                if(budgetSalary > 0) document.getElementById('budget-salary').value = budgetSalary;
                switchView('home');
                updateUI();
            }
        };

        // --- 6. SMART DATE PICKER ---
        function setupDates() {
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            
            // Calc min date (1 month ago) and max date (7 days future)
            const minDate = new Date(); minDate.setMonth(minDate.getMonth() - 1);
            const maxDate = new Date(); maxDate.setDate(maxDate.getDate() + 7);
            
            const inputs = ['tx-date', 'udhar-date'];
            inputs.forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    el.value = dateStr;
                    el.min = minDate.toISOString().split('T')[0];
                    el.max = maxDate.toISOString().split('T')[0];
                }
            });
            
            // Filter setups
            const yrSelect = document.getElementById('filter-year-input');
            const currentYear = today.getFullYear();
            for(let i=0; i<5; i++) { const opt = document.createElement('option'); opt.value = currentYear - i; opt.text = currentYear - i; yrSelect.appendChild(opt); }
        }
        
        function setTodayDate(inputId) {
            document.getElementById(inputId).value = new Date().toISOString().split('T')[0];
        }

        function initFilterUI() {
            document.getElementById('filter-month-input').value = filterState.month;
            document.getElementById('filter-year-input').value = filterState.year;
            document.getElementById('filter-type').addEventListener('change', (e) => {
                const type = e.target.value; filterState.type = type;
                document.getElementById('filter-month-input').classList.toggle('hidden', type !== 'month');
                document.getElementById('filter-year-input').classList.toggle('hidden', type !== 'year');
                document.getElementById('custom-date-range').classList.toggle('hidden', type !== 'custom');
                renderFullList();
            });
            document.getElementById('filter-month-input').addEventListener('change', (e) => { filterState.month = e.target.value; renderFullList(); });
            document.getElementById('filter-year-input').addEventListener('change', (e) => { filterState.year = e.target.value; renderFullList(); });
            document.getElementById('filter-start-date').addEventListener('change', (e) => { filterState.start = e.target.value; renderFullList(); });
            document.getElementById('filter-end-date').addEventListener('change', (e) => { filterState.end = e.target.value; renderFullList(); });
        }

        // --- 2. HISTORY FILTERS ---
        function setReportFilter(type) {
            filterState.reportFilter = type;
            // Update button styles
            document.getElementById('btn-rep-all').className = type === 'all' ? "flex-1 py-1.5 rounded-md text-[10px] font-bold bg-white shadow-sm text-slate-800" : "flex-1 py-1.5 rounded-md text-[10px] font-bold text-slate-500 hover:text-slate-700";
            document.getElementById('btn-rep-exp').className = type === 'expense' ? "flex-1 py-1.5 rounded-md text-[10px] font-bold bg-white shadow-sm text-rose-600" : "flex-1 py-1.5 rounded-md text-[10px] font-bold text-slate-500 hover:text-slate-700";
            document.getElementById('btn-rep-inc').className = type === 'income' ? "flex-1 py-1.5 rounded-md text-[10px] font-bold bg-white shadow-sm text-emerald-600" : "flex-1 py-1.5 rounded-md text-[10px] font-bold text-slate-500 hover:text-slate-700";
            renderFullList();
        }

        function getFilteredTransactions() {
            return transactions.filter(t => {
                // Time Filter
                let timeMatch = true;
                if (filterState.type === 'month') timeMatch = t.date.startsWith(filterState.month);
                else if (filterState.type === 'year') timeMatch = new Date(t.date).getFullYear() == filterState.year;
                else if (filterState.type === 'custom') { 
                    if (filterState.start && t.date < filterState.start) timeMatch = false; 
                    if (filterState.end && t.date > filterState.end) timeMatch = false; 
                }
                if(!timeMatch) return false;

                // Type Filter (Report Page)
                if(filterState.reportFilter === 'expense' && t.type !== 'expense') return false;
                if(filterState.reportFilter === 'income' && t.type !== 'income') return false;
                
                return true; 
            });
        }

        function loadGuestHistory(encodedData) {
            if(!encodedData) return;
            try {
                const jsonStr = decodeURIComponent(escape(window.atob(encodedData))); 
                const history = JSON.parse(jsonStr);
                const list = document.getElementById('guest-history-list');
                list.innerHTML = '';
                if(history.length === 0) { list.innerHTML = '<p class="text-slate-400 text-xs text-center mt-4">No recent history.</p>'; return; }
                history.forEach(item => {
                    const isLoan = item.t === 'L';
                    const color = isLoan ? 'text-orange-600' : 'text-green-600';
                    const label = isLoan ? 'Udhar Liya' : 'Wapas Diya';
                    const icon = isLoan ? 'fa-arrow-up' : 'fa-arrow-down';
                    const details = item.n ? `<br><span class="text-[9px] text-slate-400 italic">${item.n}</span>` : '';
                    list.innerHTML += `<div class="flex justify-between items-center p-3 bg-slate-50 rounded-xl border border-slate-100"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center text-xs text-slate-500"><i class="fas ${icon}"></i></div><div><p class="font-bold text-xs text-slate-700">${label} ${details}</p><p class="text-[10px] text-slate-400">${item.d}</p></div></div><span class="font-bold text-sm ${color}">${formatter.format(item.a)}</span></div>`;
                });
            } catch(e) { }
        }

        // --- Standard Logic ---
        function saveData() { localStorage.setItem('transactions', JSON.stringify(transactions)); updateUI(); }
        
        function switchView(view) {
            ['home', 'report', 'udhar', 'settings', 'budget'].forEach(v => {
                const viewEl = document.getElementById('view-'+v);
                if(viewEl) viewEl.classList.add('hidden');
                
                const navEl = document.getElementById('nav-'+v);
                if(navEl) {
                    navEl.classList.remove('active', 'text-teal-600');
                    if(v !== view) navEl.classList.add('text-slate-300');
                }
            });
            
            const targetView = document.getElementById('view-'+view);
            if(targetView) targetView.classList.remove('hidden');
            
            const targetNav = document.getElementById('nav-'+view);
            if(targetNav) { 
                targetNav.classList.add('active', 'text-teal-600'); 
                targetNav.classList.remove('text-slate-300'); 
            }
            
            currentView = view;
            if(view === 'home') updateChart();
            if(view === 'report') renderFullList();
            if(view === 'udhar') renderCustomerList();
            if(view === 'budget') updateBudgetUI();
        }

        // --- 4. BUDGET LOGIC ---
        function saveBudget() {
            const sal = parseFloat(document.getElementById('budget-salary').value);
            if(sal > 0) {
                budgetSalary = sal;
                localStorage.setItem('budgetSalary', budgetSalary);
                updateBudgetUI();
                alert("Budget Set!");
            }
        }

        function updateBudgetUI() {
            if(budgetSalary <= 0) return;
            // 50/30/20 Rule
            const limits = { needs: budgetSalary * 0.5, wants: budgetSalary * 0.3, savings: budgetSalary * 0.2 };
            
            // Calculate spent in current month
            const currentMonth = new Date().toISOString().slice(0,7);
            const spent = { needs: 0, wants: 0, savings: 0 };
            
            transactions.filter(t => t.type === 'expense' && t.date.startsWith(currentMonth)).forEach(t => {
                const catType = catConfig[t.desc]?.type || 'wants';
                spent[catType] += t.amount;
            });

            // Update UI
            updateBudgetCard('needs', limits.needs, spent.needs, 'bg-blue-500', 'text-blue-600');
            updateBudgetCard('wants', limits.wants, spent.wants, 'bg-purple-500', 'text-purple-600');
            updateBudgetCard('savings', limits.savings, spent.savings, 'bg-emerald-500', 'text-emerald-600');
        }

        function updateBudgetCard(type, limit, used, barColor, textColor) {
            document.getElementById(`${type}-limit`).innerText = `Target: ${formatter.format(limit)}`;
            const isSavings = type === 'savings';
            const label = isSavings ? 'Saved' : 'Spent';
            document.getElementById(`${type}-${isSavings?'saved':'spent'}`).innerText = `${label}: ${formatter.format(used)}`;
            
            let pct = (used / limit) * 100;
            if(pct > 100) pct = 100;
            document.getElementById(`${type}-bar`).style.width = `${pct}%`;
            
            const statusEl = document.getElementById(`${type}-status`);
            if(!isSavings) {
                if(used > limit) { statusEl.innerText = "Over Limit!"; statusEl.className = "text-red-500 font-bold blink-red"; }
                else if(used > limit * 0.9) { statusEl.innerText = "Warning"; statusEl.className = "text-orange-500 font-bold"; }
                else { statusEl.innerText = "Safe"; statusEl.className = "text-slate-400"; }
            } else {
                 if(used >= limit) { statusEl.innerText = "Goal Reached!"; statusEl.className = "text-emerald-600 font-bold"; }
                 else { statusEl.innerText = "In Progress"; statusEl.className = "text-slate-400"; }
            }
        }

        // --- ENTRY FUNCTIONS ---
        function openEntryModal() {
            editingTransactionId = null;
            document.getElementById('entry-modal-title').innerText = "New Entry";
            document.getElementById('save-btn-text').innerText = "Save Transaction";
            setTxType('expense');
            document.getElementById('tx-amount').value = '';
            document.getElementById('tx-note').value = '';
            setTodayDate('tx-date');
            document.getElementById('entry-modal').classList.remove('hidden');
        }
        function closeEntryModal() { document.getElementById('entry-modal').classList.add('hidden'); }
        function openNewUdharModal() { document.getElementById('person-history-modal').classList.add('hidden'); document.getElementById('udhar-modal').classList.remove('hidden'); document.getElementById('udhar-amount').value = ''; document.getElementById('udhar-person').value = ''; document.getElementById('udhar-phone').value = ''; setUdharType('given'); updateDatalist(); }
        function closeUdharModal() { document.getElementById('udhar-modal').classList.add('hidden'); }
        
        function setTxType(type) { document.getElementById('tx-type').value = type; const btns = { expense: document.getElementById('btn-expense'), income: document.getElementById('btn-income') }; Object.values(btns).forEach(b => { b.className = 'flex-1 py-3 rounded-lg text-slate-400 transition-all hover:text-slate-600'; }); const activeClass = "flex-1 py-3 rounded-lg font-bold transition-all shadow-sm bg-white"; if(type === 'expense') { btns.expense.className = `${activeClass} text-rose-600`; populateCats(expenseCats); } else { btns.income.className = `${activeClass} text-emerald-600`; populateCats(incomeCats); } }
        function populateCats(cats) { const sel = document.getElementById('tx-category'); sel.innerHTML = ''; cats.forEach(c => { const opt = document.createElement('option'); opt.value = c; opt.innerText = c; sel.appendChild(opt); }); }
        
        // 8. UDHAR TAKEN LOGIC
        function setUdharType(type) {
            const givenBtn = document.getElementById('btn-u-given');
            const takenBtn = document.getElementById('btn-u-taken');
            const label = document.getElementById('wallet-label');
            const saveBtn = document.getElementById('save-udhar-btn-text');
            document.getElementById('udhar-type-val').value = type;
            
            if(type === 'given') {
                givenBtn.className = "flex-1 py-3 rounded-lg shadow-sm bg-white text-orange-600";
                takenBtn.className = "flex-1 py-3 rounded-lg text-slate-400";
                label.innerText = "From Wallet";
                saveBtn.innerText = "Save Loan Given";
            } else {
                takenBtn.className = "flex-1 py-3 rounded-lg shadow-sm bg-white text-blue-600";
                givenBtn.className = "flex-1 py-3 rounded-lg text-slate-400";
                label.innerText = "To Wallet";
                saveBtn.innerText = "Save Loan Taken";
            }
        }

        function saveTransaction() {
            const type = document.getElementById('tx-type').value;
            const amount = parseFloat(document.getElementById('tx-amount').value);
            const date = document.getElementById('tx-date').value;
            const note = document.getElementById('tx-note').value;
            const cat = document.getElementById('tx-category').value;
            const acc = document.getElementById('tx-account').value;

            if(!amount || amount <= 0) return alert("Enter valid amount");

            if (editingTransactionId) {
                const idx = transactions.findIndex(t => t.id === editingTransactionId);
                if (idx !== -1) {
                    transactions[idx] = { ...transactions[idx], amount, date, note, type, desc: cat, account: acc };
                    saveData();
                    closeEntryModal();
                    return;
                }
            }

            const entry = { id: Date.now(), date, amount, type, note, desc: cat, account: acc };
            transactions.push(entry);
            saveData();
            closeEntryModal();
        }

        function saveUdharTransaction() {
            const uType = document.getElementById('udhar-type-val').value; // given or taken
            const amount = parseFloat(document.getElementById('udhar-amount').value);
            const person = document.getElementById('udhar-person').value;
            const phone = document.getElementById('udhar-phone').value;
            const source = document.getElementById('udhar-source').value;
            const date = document.getElementById('udhar-date').value;
            const rDate = document.getElementById('udhar-return-date').value;

            if(!amount || amount <= 0) return alert("Enter valid amount");
            if(!person) return alert("Person name required");

            const isLoanTaken = uType === 'taken';
            const type = isLoanTaken ? 'loan_taken' : 'udhar';
            const desc = isLoanTaken ? `Loan from ${person}` : `Loan to ${person}`;

            if (editingTransactionId) {
                const idx = transactions.findIndex(t => t.id === editingTransactionId);
                if (idx !== -1) {
                      transactions[idx] = { ...transactions[idx], amount, person, phone, account: source, date, returnDate: rDate, desc, type, isUdhar: true };
                      saveData(); closeUdharModal();
                      if(lastOpenedPerson) openPersonDetails(lastOpenedPerson);
                      renderCustomerList(); return;
                }
            }

            const entry = { id: Date.now(), date, amount, type: type, note: '', desc: desc, person, phone, account: source, returnDate: rDate, isUdhar: true, status: 'active', repaid: 0 };
            transactions.push(entry);
            saveData();
            closeUdharModal();
            if(lastOpenedPerson === person) openPersonDetails(person);
            renderCustomerList();

            if(phone) {
                const cleanPhone = phone.replace(/\D/g, '');
                const finalPhone = cleanPhone.length === 10 ? '91' + cleanPhone : cleanPhone;
                const amountFormatted = formatter.format(amount).replace('₹', '').trim();
                let msg = "";
                if(isLoanTaken) {
                    msg = `Assalamualaikum ${person},%0AMaine aapse ₹${amountFormatted} udhar liye hain.%0AInshaAllah main ${rDate || 'jald'} tak wapas kar dunga.%0AShukriya.`;
                } else {
                    msg = `Salam ${person},%0AAap ne ₹${amountFormatted} udhaar liye hain.%0AWapas karne ki Date: ${rDate || 'Tay nahi hui'}%0AEntry save kar di gayi hai.`;
                }
                window.open(`https://wa.me/${finalPhone}?text=${msg}`, '_blank');
            }
        }

        window.editTransaction = function(id) {
            const t = transactions.find(tx => tx.id === id);
            if (!t) return;
            if(t.isUdhar || t.type === 'udhar' || t.type === 'loan_taken') {
                 openNewUdharModal(); 
                 editingTransactionId = id; 
                 document.getElementById('udhar-modal-title').innerText = "Edit Loan Record";
                 document.getElementById('save-udhar-btn-text').innerText = "Update Record";
                 document.getElementById('udhar-amount').value = t.amount;
                 document.getElementById('udhar-person').value = t.person;
                 document.getElementById('udhar-phone').value = t.phone || '';
                 document.getElementById('udhar-source').value = t.account;
                 document.getElementById('udhar-date').value = t.date;
                 document.getElementById('udhar-return-date').value = t.returnDate || '';
                 setUdharType(t.type === 'loan_taken' ? 'taken' : 'given');
                 return; 
            }
            editingTransactionId = id;
            document.getElementById('entry-modal-title').innerText = "Edit Entry";
            document.getElementById('save-btn-text').innerText = "Update Transaction";
            setTxType(t.type);
            document.getElementById('tx-amount').value = t.amount;
            document.getElementById('tx-date').value = t.date;
            document.getElementById('tx-note').value = t.note || '';
            document.getElementById('tx-category').value = t.desc;
            document.getElementById('tx-account').value = t.account;
            document.getElementById('entry-modal').classList.remove('hidden');
        };

        window.deleteTransaction = function(id) {
            if(!confirm("Delete this entry?")) return;
            transactions = transactions.filter(t => t.id !== id);
            saveData();
            if(currentView === 'report') renderFullList();
            if(currentView === 'udhar' && lastOpenedPerson) openPersonDetails(lastOpenedPerson);
            updateUI();
        };

        function updateDatalist() { const names = [...new Set(transactions.filter(t => t.isUdhar).map(t => t.person))]; const datalist = document.getElementById('udhar-names-list'); datalist.innerHTML = ''; names.forEach(name => { const opt = document.createElement('option'); opt.value = name; datalist.appendChild(opt); }); document.getElementById('udhar-person').onchange = function() { const existing = transactions.find(t => t.person === this.value && t.phone); if(existing) document.getElementById('udhar-phone').value = existing.phone; } }
        async function pickContact() { try { if ('contacts' in navigator && 'ContactsManager' in window) { const contacts = await navigator.contacts.select(['name', 'tel'], { multiple: false }); if (contacts.length) { document.getElementById('udhar-person').value = contacts[0].name[0]; if (contacts[0].tel && contacts[0].tel.length) document.getElementById('udhar-phone').value = contacts[0].tel[0].replace(/\D/g, ''); return; } } } catch(e) {} showAppContactList(); }
        function showAppContactList() { const names = [...new Set(transactions.filter(t => t.isUdhar).map(t => t.person))]; const listDiv = document.getElementById('contacts-list-content'); listDiv.innerHTML = names.length ? '' : '<p class="text-xs text-slate-400 text-center">No contacts saved.</p>'; names.forEach(name => { const btn = document.createElement('button'); btn.className = "w-full text-left p-3 bg-slate-50 rounded-lg text-sm font-bold text-slate-700 flex items-center gap-3 hover:bg-slate-100"; btn.innerHTML = `<div class="w-8 h-8 rounded-full bg-teal-100 text-teal-600 flex items-center justify-center text-xs">${name.charAt(0)}</div> ${name}`; btn.onclick = () => { document.getElementById('udhar-person').value = name; const existing = transactions.find(t => t.person === name && t.phone); if(existing) document.getElementById('udhar-phone').value = existing.phone; document.getElementById('contacts-modal').classList.add('hidden'); }; listDiv.appendChild(btn); }); document.getElementById('contacts-modal').classList.remove('hidden'); }
        function timeAgo(dateStr) { const diffDays = Math.ceil(Math.abs(new Date() - new Date(dateStr)) / (1000 * 60 * 60 * 24)); if (diffDays <= 1) return 'Today'; if (diffDays === 2) return 'Yesterday'; return `${diffDays} days ago`; }

        window.showSummary = function(type) {
            const modal = document.getElementById('summary-modal');
            const title = document.getElementById('summary-title');
            const content = document.getElementById('summary-content');
            const filtered = transactions.filter(t => t.type === type);
            const total = filtered.reduce((sum, t) => sum + t.amount, 0);
            const categories = {};
            filtered.forEach(t => { categories[t.desc] = (categories[t.desc] || 0) + t.amount; });
            title.innerText = type === 'income' ? 'Income Breakdown' : 'Expense Breakdown';
            title.className = `font-bold text-lg ${type === 'income' ? 'text-emerald-700' : 'text-rose-700'}`;
            if (filtered.length === 0) content.innerHTML = '<p class="text-center text-xs text-slate-400 py-8">No records found.</p>';
            else {
                let html = `<div class="mb-4 text-center bg-slate-50 p-4 rounded-xl border border-slate-100"><p class="text-[10px] text-slate-400 uppercase tracking-widest font-bold mb-1">Total</p><h2 class="text-3xl font-bold ${type === 'income' ? 'text-emerald-600' : 'text-rose-600'}">${formatter.format(total)}</h2></div><ul class="space-y-3">`;
                Object.entries(categories).sort((a,b) => b[1] - a[1]).forEach(([cat, amount]) => {
                    const percent = ((amount / total) * 100).toFixed(1);
                    const cfg = catConfig[cat] || {icon: "fa-circle", color: "bg-slate-400", text: "text-slate-400", bgLight: "bg-slate-100"};
                    html += `<li class="flex justify-between items-center text-sm"><div class="flex items-center gap-3"><div class="w-9 h-9 rounded-full ${cfg.bgLight} ${cfg.text} flex items-center justify-center text-xs shadow-sm border border-slate-50"><i class="fas ${cfg.icon} text-xs"></i></div><div><span class="font-bold text-slate-700 text-xs block">${cat}</span><div class="w-16 h-1 bg-slate-100 rounded-full mt-1"><div class="h-full ${cfg.color}" style="width:${percent}%"></div></div></div></div><div class="text-right"><p class="font-bold text-slate-800 text-xs">${formatter.format(amount)}</p><p class="text-[10px] text-slate-400 font-bold">${percent}%</p></div></li>`;
                });
                html += '</ul>';
                content.innerHTML = html;
            }
            modal.classList.remove('hidden');
        };

        function giveMoreUdhar(name) { openNewUdharModal(); document.getElementById('udhar-person').value = name; const existing = transactions.find(t => t.person === name && t.phone); if(existing) document.getElementById('udhar-phone').value = existing.phone; }
        
        function recalculateRepayments() { 
            // Reset state
            transactions.forEach(t => { if(t.isUdhar) { t.repaid = 0; t.status = 'active'; }}); 
            
            const recoveries = transactions.filter(t => t.type === 'income' && t.desc && t.desc.startsWith('Recovery:')); 
            const recoveriesByPerson = {}; 
            recoveries.forEach(r => { const name = r.desc.replace('Recovery: ', ''); if(!recoveriesByPerson[name]) recoveriesByPerson[name] = []; recoveriesByPerson[name].push(r); }); 
            
            for(const person in recoveriesByPerson) { 
                // Only settle "Given" loans (Receivables)
                const loans = transactions.filter(t => t.type === 'udhar' && t.person === person).sort((a,b) => a.id - b.id); 
                let totalRecovered = recoveriesByPerson[person].reduce((sum, r) => sum + r.amount, 0); 
                for(const loan of loans) { 
                    if(totalRecovered <= 0) break; 
                    const allocation = Math.min(loan.amount, totalRecovered); 
                    loan.repaid += allocation; 
                    totalRecovered -= allocation; 
                    if(loan.repaid >= loan.amount - 0.1) loan.status = 'settled'; 
                } 
            } 
        }

        function updateUI() { 
            recalculateRepayments(); 
            let cash = 0, bank = 0, udhar = 0, income = 0, expense = 0; 
            
            transactions.forEach(t => { 
                if(t.type === 'income') { 
                    if(!t.isWusool) income += t.amount; 
                    t.account === 'Cash' ? cash += t.amount : bank += t.amount; 
                } 
                else if(t.type === 'expense') { 
                    expense += t.amount; 
                    t.account === 'Cash' ? cash -= t.amount : bank -= t.amount; 
                } 
                else if(t.type === 'udhar') { // Loan Given
                    const rem = t.amount - t.repaid; 
                    if (t.status === 'active' || rem > 0.1) udhar += rem; 
                    t.account === 'Cash' ? cash -= t.amount : bank -= t.amount; 
                }
                else if(t.type === 'loan_taken') { // Loan Taken
                    // Money comes IN, but it is a liability (negative udhar balance usually means payable, but here we track receivable as positive 'Udhar' stat.
                    // For logic simplicity, 'Udhar' stat usually shows receivables. Payables are hidden or should decrease 'Udhar'? 
                    // Let's keep 'Udhar' stat as "Receivables". Loan Taken increases Wallet.
                    t.account === 'Cash' ? cash += t.amount : bank += t.amount; 
                }
            }); 
            
            document.getElementById('total-balance').innerText = formatter.format(cash + bank + udhar); 
            document.getElementById('cash-balance').innerText = formatter.format(cash); 
            document.getElementById('bank-balance').innerText = formatter.format(bank); 
            document.getElementById('udhar-balance').innerText = formatter.format(udhar); 
            document.getElementById('udhar-total-display').innerText = formatter.format(udhar); 
            document.getElementById('total-income').innerText = formatter.format(income); 
            document.getElementById('total-expense').innerText = formatter.format(expense); 
            
            if(currentView === 'home') updateChart(); 
            if(currentView === 'report') renderFullList(); 
            if(currentView === 'udhar') renderCustomerList(); 
            if(currentView === 'budget') updateBudgetUI();
        }
        
        function renderCustomerList() { const list = document.getElementById('udhar-list-container'); list.innerHTML = ''; const people = {}; transactions.forEach(t => { if(t.person) { if(!people[t.person]) people[t.person] = { name: t.person, bal: 0, last: t.date, phone: t.phone }; if(t.type === 'udhar') people[t.person].bal += t.amount; else if(t.type === 'loan_taken') people[t.person].bal -= t.amount; else if(t.isWusool) people[t.person].bal -= t.amount; if(t.date > people[t.person].last) people[t.person].last = t.date; } }); const sorted = Object.values(people).sort((a,b) => b.last.localeCompare(a.last)); if(sorted.length === 0) { document.getElementById('no-udhar-msg').classList.remove('hidden'); return; } document.getElementById('no-udhar-msg').classList.add('hidden'); sorted.forEach(p => { const bal = p.bal; const color = bal > 0 ? 'text-rose-600' : (bal < 0 ? 'text-blue-600' : 'text-slate-400'); const subtext = bal > 0 ? 'You will get' : (bal < 0 ? 'You will give' : 'Settled'); const initial = p.name.charAt(0).toUpperCase(); list.innerHTML += `<div onclick="openPersonDetails('${p.name}')" class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex justify-between items-center active:scale-95 transition-transform"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 font-bold border border-slate-200">${initial}</div><div><h4 class="font-bold text-slate-800 text-sm">${p.name}</h4><p class="text-[10px] text-slate-400">${timeAgo(p.last)}</p></div></div><div class="text-right"><span class="block font-black text-sm ${color}">${formatter.format(Math.abs(bal))}</span><span class="text-[9px] font-bold text-slate-400 uppercase">${subtext}</span></div></div>`; }); }
        
        function openPersonDetails(name) { 
            recalculateRepayments();
            lastOpenedPerson = name; 
            const modal = document.getElementById('person-history-modal'); 
            document.getElementById('ph-name').innerText = name; 
            
            // Calculate total pending
            // Basic logic: Sum (Given - Taken - Recovered)
            let bal = 0;
            transactions.filter(tx => tx.person === name).forEach(tx => {
                if(tx.type === 'udhar') bal += tx.amount;
                else if(tx.type === 'loan_taken') bal -= tx.amount;
                else if(tx.isWusool) bal -= tx.amount;
            });
            
            const balanceEl = document.getElementById('ph-balance');
            balanceEl.innerText = formatter.format(Math.abs(bal));
            if(bal > 0) { balanceEl.className = "text-3xl font-bold text-rose-600 mb-1"; document.getElementById('btn-whatsapp').innerText = "Send Reminder (Payment Request)"; }
            else if(bal < 0) { balanceEl.className = "text-3xl font-bold text-blue-600 mb-1"; document.getElementById('btn-whatsapp').innerText = "Send Payment Info"; }
            else balanceEl.className = "text-3xl font-bold text-slate-400 mb-1";
            
            // Attach Events
            document.getElementById('btn-give-more').onclick = () => giveMoreUdhar(name); 
            document.getElementById('btn-receive-money').onclick = () => openWusoolForPerson(name); 
            document.getElementById('btn-settle-all').onclick = () => openWusoolForPerson(name, true);
            document.getElementById('btn-whatsapp').onclick = () => sendStatement(name, bal);

            modal.classList.remove('hidden'); 
            
            const content = document.getElementById('ph-content'); 
            content.innerHTML = ''; 
            const related = transactions.filter(t => t.person === name).sort((a,b) => b.id - a.id); 
            if(related.length === 0) content.innerHTML = '<p class="text-center text-xs text-slate-400">No history.</p>'; 
            else { 
                related.forEach(t => { 
                    let color = 'text-slate-600';
                    let icon = 'fa-circle';
                    let label = 'Unknown';
                    
                    if(t.type === 'udhar') { color='text-rose-600'; icon='fa-arrow-up'; label='Given'; }
                    else if(t.type === 'loan_taken') { color='text-blue-600'; icon='fa-arrow-down'; label='Taken'; }
                    else if(t.isWusool) { color='text-emerald-600'; icon='fa-check'; label='Received'; }

                    let editBtn = `<button onclick="editTransaction(${t.id})" class="text-slate-400 hover:text-blue-500 text-[10px] mr-2"><i class="fas fa-pencil-alt"></i></button>`; 
                    content.innerHTML += `<div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg relative"><div class="flex items-center gap-3"><i class="fas ${icon} text-xs text-slate-400"></i><div><p class="font-bold text-xs text-slate-700">${label}</p><p class="text-[10px] text-slate-400">${t.date}</p></div></div><div class="text-right"><span class="font-bold text-sm ${color} block">${formatter.format(t.amount)}</span><div class="flex justify-end mt-1">${editBtn}<button onclick="deleteTransaction(${t.id})" class="text-slate-400 hover:text-red-500 text-[10px]"><i class="fas fa-trash"></i></button></div></div></div>`; 
                }); 
            } 
        }

        function openWusoolForPerson(name, autoSettle = false) { 
            document.getElementById('person-history-modal').classList.add('hidden'); 
            
            // Calculate pending balance
            let bal = 0;
            transactions.filter(tx => tx.person === name).forEach(tx => {
                if(tx.type === 'udhar') bal += tx.amount;
                else if(tx.type === 'loan_taken') bal -= tx.amount;
                else if(tx.isWusool) bal -= tx.amount;
            });
            
            if(bal <= 0.1 && !autoSettle) return alert("No pending receivables (Udhar Given) to recover."); 
            
            document.getElementById('wusool-person-name').value = name; 
            document.getElementById('wusool-msg').innerText = `Total Pending: ${formatter.format(bal)}`; 
            document.getElementById('wusool-amount').dataset.pending = bal; 
            
            if(autoSettle) {
                 document.getElementById('wusool-amount').value = bal > 0 ? bal : '';
            } else {
                 document.getElementById('wusool-amount').value = ''; 
            }
            document.getElementById('wusool-modal').classList.remove('hidden'); 
        }

        function settleFull() {
            const pending = document.getElementById('wusool-amount').dataset.pending;
            if(pending && parseFloat(pending) > 0) {
                document.getElementById('wusool-amount').value = pending;
            } else {
                alert("Nothing to settle.");
            }
        }

        function confirmWusool() { 
            const person = document.getElementById('wusool-person-name').value; 
            const receivedAmount = parseFloat(document.getElementById('wusool-amount').value); 
            const targetAcc = document.getElementById('wusool-account').value; 
            
            if (!receivedAmount || receivedAmount <= 0) return alert("Enter valid amount"); 
            
            // Calculate previous balance to check settlement
            let bal = 0;
            transactions.filter(tx => tx.person === person).forEach(tx => {
                if(tx.type === 'udhar') bal += tx.amount;
                else if(tx.type === 'loan_taken') bal -= tx.amount;
                else if(tx.isWusool) bal -= tx.amount;
            });
            const newBal = bal - receivedAmount;

            const recoveryEntry = { 
                id: Date.now(), 
                date: new Date().toISOString().split('T')[0], 
                amount: receivedAmount, 
                type: 'income', 
                desc: `Recovery: ${person}`, 
                account: targetAcc, 
                note: 'Payment Received', 
                isWusool: true, 
                person: person 
            }; 
            
            transactions.push(recoveryEntry); 
            saveData(); 
            document.getElementById('wusool-modal').classList.add('hidden'); 
            
            if(lastOpenedPerson) openPersonDetails(lastOpenedPerson); 
            renderCustomerList(); 
            recalculateRepayments(); 
            
            // WhatsApp Logic
            const lastTx = transactions.slice().reverse().find(tx => tx.person === person && tx.phone); 
            
            if (lastTx && lastTx.phone) { 
                const cleanPhone = lastTx.phone.replace(/\D/g, ''); 
                const finalPhone = cleanPhone.length === 10 ? '91' + cleanPhone : cleanPhone; 
                
                const receivedAmountFormatted = formatter.format(receivedAmount).replace('₹', '').trim();
                const totalPendingFormatted = formatter.format(newBal).replace('₹', '').trim();

                let msg = "";
                
                if(newBal <= 1) {
                    msg = `Salam%0A${person}%0AAap ne ₹${receivedAmountFormatted} Diye%0AAb Aap ka hisaab poora ho chuka hai.%0AKoi raqam baqi nahi%0AShukriya`;
                } else {
                    msg = `Salam ${person}%0AAaj aap ki taraf se ₹${receivedAmountFormatted} receive hue hain%0ABaaqi raqam: ₹${totalPendingFormatted}%0AShukriya.`;
                }
                
                window.open(`https://wa.me/${finalPhone}?text=${msg}`, '_blank'); 
            } 
        }

        function sendStatement(person, amount) {
             const lastTx = transactions.slice().reverse().find(tx => tx.person === person && tx.phone); 
             if (lastTx && lastTx.phone) {
                 const cleanPhone = lastTx.phone.replace(/\D/g, ''); 
                 const finalPhone = cleanPhone.length === 10 ? '91' + cleanPhone : cleanPhone; 
                 const amountFormatted = formatter.format(amount).replace('₹', '').trim();
                 const msg = `Salam ${person},%0AYeh aapka Udhar statement hai.%0ATotal Pending: ₹${amountFormatted}.`;
                 window.open(`https://wa.me/${finalPhone}?text=${msg}`, '_blank'); 
             } else {
                 alert("Phone number not found for this person.");
             }
        }
        
        function renderFullList() {
            const list = document.getElementById('full-list');
            list.innerHTML = '';
            const data = getFilteredTransactions().sort((a,b) => b.id - a.id);
            
            if(data.length === 0) { list.innerHTML = '<p class="text-center text-xs text-slate-400 py-6">No records.</p>'; return; }
            
            data.forEach(t => {
                let color = t.type === 'income' ? 'text-emerald-600' : (t.type === 'udhar' ? 'text-orange-500' : (t.type === 'loan_taken' ? 'text-blue-500' : 'text-rose-600'));
                let sign = (t.type === 'income' || t.type === 'loan_taken') ? '+' : '-';
                
                const dateObj = new Date(t.id);
                const timeStr = dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                const category = t.desc;
                const note = t.note ? t.note : '-';
                const noteClass = t.note ? 'text-slate-500' : 'text-slate-300';

                const actions = `<div class="flex gap-3 ml-3 border-l border-slate-100 pl-3">
                        <button onclick="editTransaction(${t.id})" class="text-slate-400 hover:text-blue-500"><i class="fas fa-pencil-alt"></i></button>
                        <button onclick="deleteTransaction(${t.id})" class="text-slate-400 hover:text-red-500"><i class="fas fa-trash"></i></button>
                     </div>`;

                const li = document.createElement('li');
                li.className = "p-4 border-b border-slate-50 last:border-b-0 hover:bg-slate-50 transition-colors";
                li.innerHTML = `
                    <div class="flex flex-col w-full">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="font-bold text-sm text-slate-800">${category}</span>
                                    <span class="text-[9px] font-bold text-slate-400 bg-slate-100 px-1.5 py-0.5 rounded uppercase">${t.type}</span>
                                </div>
                                <p class="text-xs ${noteClass} font-medium">${note}</p>
                            </div>
                            <div class="text-right">
                                <span class="font-bold text-base ${color} block">${sign}${formatter.format(t.amount)}</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center pt-2 border-t border-dashed border-slate-100 mt-1">
                            <div class="text-[10px] text-slate-400 flex items-center gap-3 font-semibold">
                                <span class="flex items-center gap-1"><i class="far fa-calendar"></i> ${t.date}</span>
                                <span class="flex items-center gap-1"><i class="far fa-clock"></i> ${timeStr}</span>
                            </div>
                            <div class="flex items-center">${actions}</div>
                        </div>
                    </div>
                `;
                list.appendChild(li);
            });
        }

        function updateChart() { if(document.getElementById('view-home').classList.contains('hidden')) return; const ctx = document.getElementById('expenseChart').getContext('2d'); const legendContainer = document.getElementById('analysis-legend'); const expenses = {}; const currentMonth = new Date().toISOString().slice(0,7); const expenseTx = transactions.filter(t => t.type === 'expense' && t.date.startsWith(currentMonth)); const totalExpense = expenseTx.reduce((sum, t) => sum + t.amount, 0); expenseTx.forEach(t => { expenses[t.desc] = (expenses[t.desc] || 0) + t.amount; }); document.getElementById('chart-total-center').innerText = formatter.format(totalExpense); if(chartInstance) chartInstance.destroy(); chartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(expenses), datasets: [{ data: Object.values(expenses), backgroundColor: ['#f43f5e', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { display: false } } } }); legendContainer.innerHTML = ''; Object.entries(expenses).sort((a,b) => b[1] - a[1]).forEach(([cat, amount]) => { const percent = ((amount / totalExpense) * 100).toFixed(1); const cfg = catConfig[cat] || {icon: "fa-circle", color: "bg-slate-400", text: "text-slate-400", bgLight: "bg-slate-100"}; legendContainer.innerHTML += `<div class="flex justify-between items-center text-sm group"><div class="flex items-center gap-3"><div class="w-9 h-9 rounded-full ${cfg.bgLight} ${cfg.text} flex items-center justify-center ${cfg.text} shadow-sm border border-slate-50"><i class="fas ${cfg.icon} text-xs"></i></div><div><p class="font-bold text-slate-700 text-xs">${cat}</p><div class="w-24 h-1.5 bg-slate-100 rounded-full mt-1 overflow-hidden"><div class="h-full ${cfg.color} rounded-full" style="width: ${percent}%"></div></div></div></div><div class="text-right"><p class="font-bold text-slate-800 text-xs">${formatter.format(amount)}</p><p class="text-[10px] text-slate-400 font-bold">${percent}%</p></div></div>`; }); }
        
        // 7. COLOURFUL PDF
        function downloadPDF() { 
            const { jsPDF } = window.jspdf; 
            const doc = new jsPDF(); 
            
            // Header
            doc.setFontSize(18); doc.setTextColor(13, 148, 136); doc.text("Madani Exp Tracker", 14, 20); 
            doc.setFontSize(10); doc.setTextColor(100); doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 28); 
            
            const data = getFilteredTransactions(); 
            const rows = data.map(t => { 
                const dateObj = new Date(t.id);
                return [
                    t.date, 
                    t.desc, 
                    t.type.toUpperCase(), 
                    formatter.format(t.amount)
                ]; 
            }); 
            
            doc.autoTable({ 
                head: [['Date', 'Category', 'Type', 'Amount']], 
                body: rows, 
                startY: 35, 
                theme: 'grid', 
                styles: { fontSize: 9, cellPadding: 4 }, 
                headStyles: { fillColor: [13, 148, 136], textColor: 255, fontStyle: 'bold' }, // Blue Heading
                didParseCell: function(data) {
                    if (data.section === 'body' && data.column.index === 3) {
                        const type = rows[data.row.index][2];
                        if (type === 'INCOME' || type.includes('RECOVERY') || type === 'LOAN_TAKEN') {
                            data.cell.styles.textColor = [22, 163, 74]; // Green
                        } else {
                            data.cell.styles.textColor = [220, 38, 38]; // Red
                        }
                        data.cell.styles.fontStyle = 'bold';
                    }
                }
            }); 
            doc.save('Madani_Report.pdf'); 
        }
        
        function exportData() { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(transactions)); const a = document.createElement('a'); a.href = dataStr; a.download = "backup.json"; a.click(); }
        
        // 5. BACKUP RESTORE (MERGE/REPLACE)
        function triggerRestore() {
            document.getElementById('import-file').value = null; // reset
            document.getElementById('import-file').click();
        }
        
        function processImport(input) {
            const reader = new FileReader(); 
            reader.onload = function(e) { 
                try {
                    tempImportData = JSON.parse(e.target.result); 
                    if(Array.isArray(tempImportData)) {
                        document.getElementById('restore-modal').classList.remove('hidden');
                    } else {
                        alert("Invalid file format");
                    }
                } catch(err) { alert("Error reading file"); }
            }; 
            reader.readAsText(input.files[0]); 
        }
        
        function confirmRestore(action) {
            if(!tempImportData) return;
            if(action === 'replace') {
                transactions = tempImportData;
            } else {
                // Merge based on ID
                const currentIds = new Set(transactions.map(t => t.id));
                tempImportData.forEach(t => {
                    if(!currentIds.has(t.id)) transactions.push(t);
                });
            }
            saveData();
            document.getElementById('restore-modal').classList.add('hidden');
            alert("Data Restored Successfully!");
        }
        
        function clearAll() { if(confirm("⚠️ Critical Warning:\nReset App?")) { transactions = []; saveData(); updateUI(); alert("Reset Done."); } }
        function exitApp() { if(confirm("Exit App?")) { window.close(); if(!window.closed) alert("Close tab manually."); } }
    </script>
</body>
</html>
