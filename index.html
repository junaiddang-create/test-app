<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Madani Exp Tracker</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fab-shadow { box-shadow: 0 4px 15px rgba(13, 148, 136, 0.4); }
        .nav-item.active { color: #0d9488; }
        .nav-item { color: #94a3b8; transition: color 0.3s; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        select { -webkit-appearance: none; appearance: none; }
        #guest-container { display: none; }
        
        /* Khata Book Specific Styles */
        .khata-gradient { background: linear-gradient(135deg, #0f172a 0%, #334155 100%); }
        .glass-panel { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
    </style>
</head>
<body class="text-slate-800 bg-slate-50">

    <!-- === MAIN APP CONTAINER === -->
    <div id="main-container" class="w-full max-w-md mx-auto min-h-screen relative bg-white sm:shadow-xl overflow-hidden pb-[90px]">
        
        <!-- HEADER -->
        <header class="bg-white p-4 sticky top-0 z-30 shadow-sm border-b border-slate-100 flex justify-between items-center">
            <div>
                <h1 class="text-lg font-bold text-teal-700 flex items-center gap-2"><i class="fas fa-wallet"></i> Madani Exp Tracker</h1>
                <p class="text-[10px] text-teal-600 font-bold ml-7 -mt-1 tracking-wide">Junaid Madani</p>
            </div>
            <div class="text-right">
                <p class="text-[10px] text-slate-400 uppercase tracking-wider font-bold" id="net-balance-label">Net Balance</p>
                <h2 class="text-xl font-bold text-slate-800" id="total-balance">₹0</h2>
            </div>
        </header>

        <!-- === 1. HOME VIEW === -->
        <section id="view-home" class="p-4 fade-in block pb-24">
            <!-- HOME FILTERS -->
            <div class="flex p-1 bg-slate-200/60 rounded-xl mb-5 mx-1">
                <button onclick="setHomeFilter('day')" id="hf-day" class="flex-1 py-2 text-xs font-bold rounded-lg transition-all text-slate-500">Daily</button>
                <button onclick="setHomeFilter('month')" id="hf-month" class="flex-1 py-2 text-xs font-bold rounded-lg transition-all bg-white shadow-sm text-teal-700">Monthly</button>
                <button onclick="setHomeFilter('year')" id="hf-year" class="flex-1 py-2 text-xs font-bold rounded-lg transition-all text-slate-500">Yearly</button>
            </div>

            <!-- Assets Cards -->
            <div class="grid grid-cols-3 gap-3 mb-5">
                <div class="bg-blue-50 p-3 rounded-xl border border-blue-100 text-center relative overflow-hidden group">
                    <i class="fas fa-money-bill-wave absolute -bottom-2 -right-2 text-4xl text-blue-100 opacity-50"></i>
                    <p class="text-[10px] text-slate-500 uppercase font-bold relative z-10">Cash</p>
                    <p class="text-sm font-bold text-slate-800 relative z-10" id="cash-balance">₹0</p>
                </div>
                <div class="bg-indigo-50 p-3 rounded-xl border border-indigo-100 text-center relative overflow-hidden group">
                    <i class="fas fa-university absolute -bottom-2 -right-2 text-4xl text-indigo-100 opacity-50"></i>
                    <p class="text-[10px] text-slate-500 uppercase font-bold relative z-10">Bank</p>
                    <p class="text-sm font-bold text-slate-800 relative z-10" id="bank-balance">₹0</p>
                </div>
                <div class="bg-orange-50 p-3 rounded-xl border border-orange-100 text-center relative overflow-hidden group">
                    <i class="fas fa-hand-holding-usd absolute -bottom-2 -right-2 text-4xl text-orange-100 opacity-50"></i>
                    <p class="text-[10px] text-slate-500 uppercase font-bold relative z-10">Udhar</p>
                    <p class="text-sm font-bold text-orange-600 relative z-10" id="udhar-balance">₹0</p>
                </div>
            </div>

            <!-- Opening Balance Info -->
            <div id="opening-balance-container" class="mb-3 px-1 flex justify-between items-center text-xs text-slate-400 font-semibold hidden">
                <span><i class="fas fa-history mr-1"></i> Carry Forward (Opening):</span>
                <span id="opening-balance-val" class="text-slate-600 font-bold">₹0</span>
            </div>

            <!-- Flow Cards -->
            <div class="grid grid-cols-2 gap-3 mb-6">
                <div onclick="showSummary('income')" class="cursor-pointer bg-emerald-50 p-4 rounded-xl border border-emerald-100 flex justify-between items-center active:scale-95 transition-transform">
                    <div><p class="text-[10px] text-emerald-600 font-bold uppercase" id="lbl-income">Income</p><p class="text-lg font-bold text-emerald-700" id="total-income">₹0</p></div>
                    <div class="bg-emerald-200/50 w-8 h-8 rounded-full flex items-center justify-center text-emerald-700"><i class="fas fa-arrow-down"></i></div>
                </div>
                <div onclick="showSummary('expense')" class="cursor-pointer bg-rose-50 p-4 rounded-xl border border-rose-100 flex justify-between items-center active:scale-95 transition-transform">
                    <div><p class="text-[10px] text-rose-600 font-bold uppercase" id="lbl-expense">Expense</p><p class="text-lg font-bold text-rose-700" id="total-expense">₹0</p></div>
                    <div class="bg-rose-200/50 w-8 h-8 rounded-full flex items-center justify-center text-rose-700"><i class="fas fa-arrow-up"></i></div>
                </div>
            </div>

            <h3 class="font-bold text-slate-700 text-sm mb-3">Expense Analysis <span id="analysis-period-lbl" class="text-[10px] font-normal text-slate-400 ml-1"></span></h3>
            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100 mb-4">
                <div class="flex justify-center mb-6 relative">
                    <div class="h-48 w-48 relative z-10"><canvas id="expenseChart"></canvas></div>
                    <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none"><p class="text-[10px] text-slate-400 uppercase font-bold">Total</p><p class="text-lg font-bold text-slate-800" id="chart-total-center">₹0</p></div>
                </div>
                <div id="analysis-legend" class="space-y-3"></div>
            </div>
        </section>

        <!-- === 2. REPORT VIEW === -->
        <section id="view-report" class="p-4 fade-in hidden pb-24">
            <h2 class="text-lg font-bold mb-4">Reports & History</h2>
            <div class="bg-slate-100 p-1 rounded-xl flex font-bold text-xs mb-4">
                <button onclick="setHistoryFilter('all')" id="hf-all" class="flex-1 py-2 rounded-lg bg-white shadow-sm text-slate-800 transition-all">All</button>
                <button onclick="setHistoryFilter('expense')" id="hf-expense" class="flex-1 py-2 rounded-lg text-slate-500 transition-all hover:text-rose-600">Debit</button>
                <button onclick="setHistoryFilter('income')" id="hf-income" class="flex-1 py-2 rounded-lg text-slate-500 transition-all hover:text-emerald-600">Credit</button>
            </div>
            <div class="bg-slate-50 p-3 rounded-xl border border-slate-200 mb-4">
                <div class="flex gap-2 mb-2">
                    <select id="filter-type" class="w-1/3 p-2 text-xs rounded-lg border border-slate-300"><option value="month">Monthly</option><option value="year">Yearly</option><option value="custom">Custom</option><option value="all">All Time</option></select>
                    <input type="month" id="filter-month-input" class="w-2/3 p-2 text-xs rounded-lg border border-slate-300">
                    <select id="filter-year-input" class="hidden w-2/3 p-2 text-xs rounded-lg border border-slate-300"></select>
                </div>
                <div id="custom-date-range" class="hidden flex gap-2 mt-3">
                    <div class="relative w-1/2">
                        <span class="absolute -top-2 left-2 bg-slate-50 px-1 text-[9px] text-slate-400 font-bold">From</span>
                        <input type="date" id="filter-start-date" class="w-full p-2 text-xs rounded-lg border border-slate-300">
                    </div>
                    <div class="relative w-1/2">
                        <span class="absolute -top-2 left-2 bg-slate-50 px-1 text-[9px] text-slate-400 font-bold">To</span>
                        <input type="date" id="filter-end-date" class="w-full p-2 text-xs rounded-lg border border-slate-300">
                    </div>
                </div>
            </div>
            <button onclick="downloadPDF()" class="w-full bg-slate-800 text-white py-3 rounded-xl text-sm font-bold shadow-lg flex items-center justify-center gap-2 active:scale-95 mb-4 hover:bg-slate-900"><i class="fas fa-file-pdf text-red-400"></i> Get Statement</button>
            <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden"><ul id="full-list" class="divide-y divide-slate-50"></ul></div>
        </section>

        <!-- === 3. BUDGET VIEW === -->
        <section id="view-budget" class="p-4 fade-in hidden pb-24">
            <h2 class="text-lg font-bold mb-4">Budget Planning (50/30/20)</h2>
            <div class="bg-gradient-to-r from-teal-500 to-teal-700 p-5 rounded-2xl shadow-lg border border-teal-600 mb-6 text-white relative overflow-hidden">
                <div class="absolute right-0 top-0 opacity-10"><i class="fas fa-wallet text-9xl"></i></div>
                <p class="text-[10px] font-bold uppercase tracking-widest mb-1 opacity-80">This Month's Salary</p>
                <h1 class="text-3xl font-black mb-1" id="budget-salary-display">₹0</h1>
                <p class="text-[9px] font-medium opacity-80 flex items-center gap-1"><i class="fas fa-sync-alt"></i> Auto-detected from Income entries</p>
            </div>
            <div id="budget-content" class="space-y-4 mb-8">
                <!-- Needs -->
                <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center"><i class="fas fa-home text-xs"></i></div><div><h3 class="font-bold text-sm text-slate-700">Needs (50%)</h3><p class="text-[10px] text-slate-400 font-bold" id="budget-needs-limit">Limit: ₹0</p></div></div>
                        <div class="text-right"><p class="font-bold text-sm text-blue-600" id="budget-needs-val">₹0</p><p class="text-[10px] text-slate-400">Spent</p><p class="text-[10px] font-bold" id="budget-needs-rem">Baqi: ₹0</p></div>
                    </div>
                    <div class="w-full h-2 bg-slate-100 rounded-full overflow-hidden"><div id="bar-needs" class="h-full bg-blue-500 rounded-full transition-all duration-500" style="width: 0%"></div></div>
                    <div id="list-needs" class="mt-3 pt-2 border-t border-slate-50 space-y-2"></div>
                </div>
                <!-- Wants -->
                <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-purple-50 text-purple-600 flex items-center justify-center"><i class="fas fa-shopping-bag text-xs"></i></div><div><h3 class="font-bold text-sm text-slate-700">Wants (30%)</h3><p class="text-[10px] text-slate-400 font-bold" id="budget-wants-limit">Limit: ₹0</p></div></div>
                        <div class="text-right"><p class="font-bold text-sm text-purple-600" id="budget-wants-val">₹0</p><p class="text-[10px] text-slate-400">Spent</p><p class="text-[10px] font-bold" id="budget-wants-rem">Baqi: ₹0</p></div>
                    </div>
                    <div class="w-full h-2 bg-slate-100 rounded-full overflow-hidden"><div id="bar-wants" class="h-full bg-purple-500 rounded-full transition-all duration-500" style="width: 0%"></div></div>
                    <div id="list-wants" class="mt-3 pt-2 border-t border-slate-50 space-y-2"></div>
                </div>
                <!-- Savings -->
                <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center gap-2"><div class="w-8 h-8 rounded-full bg-emerald-50 text-emerald-600 flex items-center justify-center"><i class="fas fa-piggy-bank text-xs"></i></div><div><h3 class="font-bold text-sm text-slate-700">Savings (20%)</h3><p class="text-[10px] text-slate-400 font-bold" id="budget-savings-limit">Target: ₹0</p></div></div>
                        <div class="text-right"><p class="font-bold text-sm text-emerald-600" id="budget-savings-val">₹0</p><p class="text-[10px] text-slate-400">Saved</p><p class="text-[10px] font-bold" id="budget-savings-rem">Baqi: ₹0</p></div>
                    </div>
                    <div class="w-full h-2 bg-slate-100 rounded-full overflow-hidden"><div id="bar-savings" class="h-full bg-emerald-500 rounded-full transition-all duration-500" style="width: 0%"></div></div>
                    <div id="list-savings" class="mt-3 pt-2 border-t border-slate-50 space-y-2"></div>
                </div>
            </div>
            <div class="mb-4 flex justify-between items-center">
                <h3 class="font-bold text-sm text-slate-700">Category Wise Limits</h3>
                <button onclick="document.getElementById('cat-budget-modal').classList.remove('hidden')" class="bg-slate-800 text-white px-3 py-1.5 rounded-lg text-xs font-bold active:scale-95"><i class="fas fa-plus"></i> Add Limit</button>
            </div>
            <div id="custom-budgets-list" class="space-y-3"></div>
        </section>

        <!-- === 4. UDHAR VIEW (KHATA BOOK STYLE) === -->
        <section id="view-udhar" class="p-4 fade-in hidden pb-24">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-slate-800">Khata Book</h2>
                <button onclick="openNewUdharModal()" class="bg-slate-800 text-white px-4 py-2.5 rounded-xl text-xs font-bold shadow-lg hover:bg-slate-900 active:scale-95 flex items-center gap-2"><i class="fas fa-user-plus"></i> Add Customer</button>
            </div>
            
            <!-- Summary Dashboard (Premium Look) -->
            <div class="khata-gradient p-5 rounded-2xl shadow-lg border border-slate-700 mb-6 text-white relative overflow-hidden">
                <div class="absolute -right-6 -top-6 text-white opacity-5"><i class="fas fa-book text-9xl"></i></div>
                <div class="flex justify-between items-center relative z-10 divide-x divide-slate-600">
                    <div class="flex-1 pr-4 text-center">
                        <p class="text-[10px] font-bold uppercase tracking-widest opacity-70 mb-1 text-emerald-300">Kul Lene Hain</p>
                        <p class="text-xl font-bold text-emerald-400" id="total-lene-hai">₹0</p>
                    </div>
                    <div class="flex-1 pl-4 text-center">
                        <p class="text-[10px] font-bold uppercase tracking-widest opacity-70 mb-1 text-rose-300">Kul Dene Hain</p>
                        <p class="text-xl font-bold text-rose-400" id="total-dene-hai">₹0</p>
                    </div>
                </div>
            </div>

            <!-- Customer List -->
            <div id="udhar-list-container" class="space-y-3"></div>
            <p id="no-udhar-msg" class="text-center text-slate-400 text-xs py-10 hidden">No active accounts.</p>
        </section>

        <!-- === 5. SETTINGS VIEW === -->
        <section id="view-settings" class="p-4 fade-in hidden pb-24">
            <h2 class="text-lg font-bold mb-4">Settings</h2>
            <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                <button onclick="exportData()" class="w-full text-left p-4 hover:bg-slate-50 flex items-center gap-3 border-b border-slate-50"><div class="w-8 h-8 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center"><i class="fas fa-save"></i></div><div><p class="text-sm font-bold text-slate-700">Backup Data</p><p class="text-[10px] text-slate-400">Save to device</p></div></button>
                <button onclick="document.getElementById('import-file').click()" class="w-full text-left p-4 hover:bg-slate-50 flex items-center gap-3 border-b border-slate-50"><div class="w-8 h-8 rounded-full bg-green-50 text-green-600 flex items-center justify-center"><i class="fas fa-file-import"></i></div><div><p class="text-sm font-bold text-slate-700">Restore Data</p><p class="text-[10px] text-slate-400">Replace current data with backup</p></div></button>
                <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(this)">
                <button onclick="clearAll()" class="w-full text-left p-4 hover:bg-red-50 flex items-center gap-3 border-b border-slate-50"><div class="w-8 h-8 rounded-full bg-red-50 text-red-600 flex items-center justify-center"><i class="fas fa-trash-alt"></i></div><div><p class="text-sm font-bold text-red-600">Reset App</p><p class="text-[10px] text-red-400">Delete all data</p></div></button>
                <button onclick="exitApp()" class="w-full text-left p-4 hover:bg-slate-50 flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center"><i class="fas fa-power-off"></i></div><div><p class="text-sm font-bold text-slate-700">Exit App</p><p class="text-[10px] text-slate-400">Close application</p></div></button>
            </div>
            <p class="text-center text-[10px] text-slate-300 mt-8 font-semibold tracking-wide">Madani Exp Tracker v39.0 (Standard)</p>
        </section>

        <!-- NAV -->
        <nav class="fixed bottom-0 w-full max-w-md bg-white border-t border-slate-100 flex justify-between items-end px-4 pb-2 pt-2 z-40 shadow-lg" style="left: 50%; transform: translateX(-50%);">
            <button onclick="switchView('home')" class="nav-item active flex flex-col items-center gap-1" id="nav-home"><i class="fas fa-home text-lg"></i><span class="text-[9px] font-bold">Home</span></button>
            <button onclick="switchView('report')" class="nav-item flex flex-col items-center gap-1" id="nav-report"><i class="fas fa-chart-pie text-lg"></i><span class="text-[9px] font-bold">History</span></button>
            <div class="relative w-12 flex justify-center z-50"><button onclick="openEntryModal()" class="absolute -top-10 bg-teal-600 text-white w-14 h-14 rounded-full flex items-center justify-center text-2xl fab-shadow transition-transform active:scale-90 border-[4px] border-slate-50 shadow-lg shadow-teal-100"><i class="fas fa-plus"></i></button></div>
            <button onclick="switchView('budget')" class="nav-item flex flex-col items-center gap-1" id="nav-budget"><i class="fas fa-wallet text-lg"></i><span class="text-[9px] font-bold">Budget</span></button>
            <button onclick="switchView('udhar')" class="nav-item flex flex-col items-center gap-1" id="nav-udhar"><i class="fas fa-hand-holding-usd text-lg"></i><span class="text-[9px] font-bold">Udhar</span></button>
            <button onclick="switchView('settings')" class="nav-item flex flex-col items-center gap-1" id="nav-settings"><i class="fas fa-cog text-lg"></i><span class="text-[9px] font-bold">Setting</span></button>
        </nav>
    </div>

    <!-- ENTRY MODAL -->
    <div id="entry-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-end justify-center sm:items-center p-0 sm:p-4 fade-in"><div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl"><div class="flex justify-between items-center mb-6"><h3 class="font-bold text-lg text-slate-800" id="entry-modal-title">New Entry</h3><button onclick="closeEntryModal()" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 flex items-center justify-center"><i class="fas fa-times"></i></button></div><div class="space-y-4"><div class="bg-slate-100 p-1 rounded-xl flex font-bold text-xs" id="type-tabs-wrapper"><button onclick="setTxType('expense')" id="btn-expense" class="flex-1 py-3 rounded-lg shadow-sm bg-white text-rose-600">Expense</button><button onclick="setTxType('income')" id="btn-income" class="flex-1 py-3 rounded-lg text-slate-400">Income</button><button onclick="setTxType('transfer')" id="btn-transfer" class="flex-1 py-3 rounded-lg text-slate-400">Transfer</button></div><input type="hidden" id="tx-type" value="expense"><div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Amount</label><input type="number" id="tx-amount" placeholder="0" class="w-full pl-4 p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-xl text-slate-800 focus:outline-none focus:border-teal-500"></div><div id="cat-wrapper" class="grid grid-cols-1 gap-3"><div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Category</label><select id="tx-category" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold text-slate-700 outline-none focus:border-teal-500"></select></div></div><div id="account-wrapper"><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Wallet</label><select id="tx-account" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold text-slate-700 outline-none focus:border-teal-500"><option value="Cash">Cash</option><option value="Bank">Bank Account</option></select></div><div id="transfer-wrapper" class="hidden items-end gap-2">
        <div class="flex-1">
            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">From</label>
            <select id="transfer-from" onchange="syncTransferDest()" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold text-slate-700 outline-none focus:border-teal-500">
                <option value="Cash">Cash</option>
                <option value="Bank">Bank</option>
            </select>
        </div>
        <div class="pb-3 text-slate-400 text-lg flex justify-center w-8"><i class="fas fa-exchange-alt"></i></div>
        <div class="flex-1">
            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">To</label>
            <select id="transfer-to" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold text-slate-700 outline-none focus:border-teal-500">
                <option value="Bank">Bank</option>
                <option value="Cash">Cash</option>
            </select>
        </div>
    </div><div class="grid grid-cols-2 gap-3"><div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Date</label><input type="date" id="tx-date" onchange="highlightDate(this)" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold outline-none"></div><div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Note</label><input type="text" id="tx-note" placeholder="Details..." class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold outline-none"></div></div><button onclick="saveTransaction()" class="w-full bg-teal-600 text-white font-bold py-3.5 rounded-xl shadow-lg active:scale-95 flex justify-center items-center gap-2 mt-2"><i class="fas fa-check"></i> <span id="save-btn-text">Save Transaction</span></button></div></div></div>

    <!-- KHATA BOOK NEW ENTRY MODAL -->
    <div id="udhar-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-end justify-center sm:items-center p-0 sm:p-4 fade-in"><div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl"><div class="flex justify-between items-center mb-6"><h3 class="font-bold text-lg text-slate-800" id="udhar-modal-title">New Entry</h3><button onclick="closeUdharModal()" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 flex items-center justify-center"><i class="fas fa-times"></i></button></div><div class="space-y-4">
        <!-- Main Choice -->
        <div class="flex gap-2">
            <button onclick="setLoanType('given')" id="btn-loan-given" class="flex-1 py-4 rounded-xl border border-rose-100 bg-rose-50 text-rose-600 font-bold flex flex-col items-center gap-1"><i class="fas fa-arrow-up text-xl"></i> MAINE DIYE (GAVE)</button>
            <button onclick="setLoanType('taken')" id="btn-loan-taken" class="flex-1 py-4 rounded-xl border border-emerald-100 bg-emerald-50 text-emerald-600 font-bold flex flex-col items-center gap-1"><i class="fas fa-arrow-down text-xl"></i> MAINE LIYE (GOT)</button>
        </div>
        <input type="hidden" id="loan-type" value="given">
        
        <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Amount</label><input type="number" id="udhar-amount" placeholder="0" class="w-full pl-4 p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-xl text-slate-800 focus:outline-none focus:border-blue-500"></div>
        <button onclick="pickContact()" class="w-full py-3 bg-slate-50 border border-dashed border-slate-300 rounded-xl text-slate-600 font-bold text-xs flex items-center justify-center gap-2 hover:bg-slate-100"><i class="fas fa-address-book text-lg"></i> Select from Contacts</button>
        <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Person Name</label><input type="text" id="udhar-person" list="udhar-names-list" placeholder="Enter Name" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold text-slate-700 outline-none focus:border-blue-500"><datalist id="udhar-names-list"></datalist></div>
        <div class="grid grid-cols-2 gap-3"><div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Mobile (WA)</label><input type="tel" id="udhar-phone" placeholder="91..." class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold text-slate-700 outline-none focus:border-blue-500"></div><div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Source Wallet</label><select id="udhar-source" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold text-slate-700 outline-none focus:border-blue-500"><option value="Cash">Cash</option><option value="Bank">Bank Account</option></select></div></div><div class="grid grid-cols-2 gap-3"><div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Date</label><input type="date" id="udhar-date" onchange="highlightDate(this)" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs font-semibold text-slate-700 outline-none"></div><div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Due Date (Optional)</label><input type="date" id="udhar-return-date" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs font-semibold text-slate-700 outline-none"></div></div><button onclick="saveUdharTransaction()" class="w-full bg-slate-800 text-white font-bold py-3.5 rounded-xl shadow-lg hover:bg-slate-900 active:scale-95 flex justify-center items-center gap-2 mt-2"><i class="fas fa-save"></i> <span id="save-udhar-btn-text">Save Entry</span></button></div></div></div>
    
    <div id="cat-budget-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4 fade-in"><div class="bg-white w-full max-w-xs rounded-2xl p-5 shadow-2xl"><div class="flex justify-between items-center mb-4 border-b border-slate-50 pb-2"><h3 class="font-bold text-lg text-slate-800" id="cat-budget-title">Add Budget Limit</h3><button onclick="document.getElementById('cat-budget-modal').classList.add('hidden')" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 flex items-center justify-center"><i class="fas fa-times"></i></button></div><div class="space-y-3"><div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Select Category</label><select id="budget-cat-select" class="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg text-sm font-semibold outline-none"></select></div><div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Monthly Limit (Rs.)</label><input type="number" id="budget-cat-limit" placeholder="e.g. 5000" class="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg font-bold text-slate-800 outline-none focus:border-teal-500"></div><button onclick="saveCategoryLimit()" class="w-full bg-slate-800 text-white py-3 rounded-xl text-xs font-bold mt-2">Save Limit</button></div></div></div>
    <div id="summary-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4 fade-in"><div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2"><h3 class="font-bold text-lg text-slate-800" id="summary-title">Summary</h3><button onclick="document.getElementById('summary-modal').classList.add('hidden')" class="w-8 h-8 rounded-full bg-slate-100 text-slate-400 hover:bg-slate-200 flex items-center justify-center"><i class="fas fa-times"></i></button></div><div id="summary-content" class="space-y-3 max-h-96 overflow-y-auto no-scrollbar"></div></div></div>
    
    <!-- KHATA BOOK LEDGER MODAL -->
    <div id="person-history-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-end sm:items-center justify-center p-0 sm:p-4 fade-in"><div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl shadow-2xl flex flex-col h-[85vh]"><div class="flex justify-between items-center p-4 border-b border-slate-100 bg-white rounded-t-3xl"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 font-bold text-lg"><i class="fas fa-user"></i></div><div><h3 class="font-bold text-lg text-slate-800" id="ph-name">Name</h3><p class="text-[10px] text-slate-400 flex items-center gap-1"><i class="fab fa-whatsapp"></i> <span id="ph-phone">No number</span></p></div></div><button onclick="document.getElementById('person-history-modal').classList.add('hidden')" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 hover:bg-slate-100 flex items-center justify-center"><i class="fas fa-times"></i></button></div>
    <!-- Actions Bar: Reminder, Settle -->
    <div class="flex gap-2 px-4 py-2 border-b border-slate-50 bg-slate-50/50">
        <button id="btn-ledger-reminder" class="flex-1 py-2 bg-green-50 text-green-600 rounded-lg text-xs font-bold border border-green-100 flex items-center justify-center gap-1 active:scale-95"><i class="fab fa-whatsapp"></i> Reminder</button>
        <button id="btn-ledger-settle" class="flex-1 py-2 bg-blue-50 text-blue-600 rounded-lg text-xs font-bold border border-blue-100 flex items-center justify-center gap-1 active:scale-95"><i class="fas fa-check-double"></i> Settle</button>
    </div>
    <!-- Ledger Content -->
    <div class="flex-1 overflow-y-auto bg-slate-50 p-2" id="ph-content"></div>
    <!-- Footer Buttons -->
    <div class="p-4 bg-white border-t border-slate-100 grid grid-cols-2 gap-3"><button id="btn-ledger-give" class="py-3 bg-rose-50 text-rose-600 font-bold rounded-xl border border-rose-100 flex items-center justify-center gap-2 active:scale-95"> <i class="fas fa-arrow-up"></i> MAINE DIYE </button><button id="btn-ledger-get" class="py-3 bg-emerald-50 text-emerald-600 font-bold rounded-xl border border-emerald-100 flex items-center justify-center gap-2 active:scale-95"> <i class="fas fa-arrow-down"></i> MAINE LIYE </button></div></div></div>
    
    <div id="contacts-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-[60] flex items-center justify-center p-4 fade-in"><div class="bg-white w-full max-w-xs rounded-2xl p-5 shadow-2xl"><div class="flex justify-between items-center mb-3 border-b border-slate-100 pb-2"><h3 class="font-bold text-slate-800">Select Contact</h3><button onclick="document.getElementById('contacts-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button></div><div id="contacts-list-content" class="space-y-2 max-h-60 overflow-y-auto no-scrollbar"></div></div></div>
    
    <!-- WUSOOL / SETTLE MODAL -->
    <div id="wusool-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4 fade-in"><div class="bg-white w-full max-w-xs rounded-2xl p-5 shadow-2xl"><div class="flex justify-between items-center mb-4 border-b border-slate-50 pb-2"><h3 class="font-bold text-lg text-slate-800" id="wusool-modal-title">Receive Money</h3><button onclick="document.getElementById('wusool-modal').classList.add('hidden')" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 flex items-center justify-center"><i class="fas fa-times"></i></button></div><p class="text-xs text-slate-500 mb-2 font-bold" id="wusool-msg">Settling...</p><input type="hidden" id="wusool-person-name"><label class="block text-[10px] font-bold text-emerald-600 uppercase mb-2 ml-1">Received Amount</label><div class="flex gap-2 mb-3"><input type="number" id="wusool-amount" class="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg text-lg font-bold text-slate-800 focus:outline-none focus:border-teal-500"><button onclick="settleFull()" class="bg-emerald-100 text-emerald-700 px-3 py-2 rounded-lg text-xs font-bold whitespace-nowrap active:scale-95">Full Settle</button></div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-2 ml-1">Deposit To</label><select id="wusool-account" class="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg text-sm font-semibold mb-4"><option value="Cash">Cash</option><option value="Bank">Bank Account</option></select><div class="flex gap-2"><button onclick="document.getElementById('wusool-modal').classList.add('hidden')" class="flex-1 py-2 text-slate-500 font-bold text-xs bg-slate-100 rounded-lg">Cancel</button><button onclick="confirmWusool()" class="flex-1 py-2 text-white font-bold text-xs bg-emerald-600 rounded-lg">Confirm</button></div></div></div>

    <script>
        // --- 1. STATE & CONFIG ---
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let categoryLimits = JSON.parse(localStorage.getItem('categoryLimits')) || {};
        let chartInstance = null;
        let editingTransactionId = null;
        let lastOpenedPerson = null;
        let currentView = 'home';
        // Initialize State with Local Time
        const _now = new Date();
        const _m = String(_now.getMonth() + 1).padStart(2, '0');
        const _y = _now.getFullYear();
        const _curMonth = `${_y}-${_m}`;
        const _today = `${_y}-${_m}-${String(_now.getDate()).padStart(2, '0')}`;
        
        let filterState = { 
            type: 'month', 
            month: _curMonth, 
            year: _y, 
            start: _today, 
            end: _today, 
            txType: 'all' 
        };
        let homeFilterState = { period: 'month' }; 

        const catConfig = {
            "Food & Groceries": { icon: "fa-utensils", color: "bg-orange-500", text: "text-orange-500", bgLight: "bg-orange-50", type: "needs" },
            "Utilities": { icon: "fa-lightbulb", color: "bg-yellow-500", text: "text-yellow-600", bgLight: "bg-yellow-50", type: "needs" },
            "Mobile & Recharge": { icon: "fa-mobile-alt", color: "bg-blue-400", text: "text-blue-500", bgLight: "bg-blue-50", type: "needs" },
            "Transportation": { icon: "fa-bus", color: "bg-indigo-500", text: "text-indigo-500", bgLight: "bg-indigo-50", type: "needs" },
            "Medical & Health": { icon: "fa-briefcase-medical", color: "bg-green-500", text: "text-green-500", bgLight: "bg-green-50", type: "needs" },
            "Personal Care": { icon: "fa-pump-soap", color: "bg-teal-500", text: "text-teal-500", bgLight: "bg-teal-50", type: "needs" },
            "Family Shopping": { icon: "fa-shopping-bag", color: "bg-purple-500", text: "text-purple-500", bgLight: "bg-purple-50", type: "wants" },
            "Eating Out": { icon: "fa-hamburger", color: "bg-rose-500", text: "text-rose-500", bgLight: "bg-rose-50", type: "wants" },
            "EMI / Loan": { icon: "fa-percentage", color: "bg-slate-600", text: "text-slate-600", bgLight: "bg-slate-100", type: "needs" },
            "Family Support": { icon: "fa-hands-helping", color: "bg-pink-500", text: "text-pink-500", bgLight: "bg-pink-50", type: "needs" },
            "Donations & Charity": { icon: "fa-hand-holding-heart", color: "bg-red-400", text: "text-red-500", bgLight: "bg-red-50", type: "wants" },
            "Savings & Investment": { icon: "fa-piggy-bank", color: "bg-emerald-600", text: "text-emerald-700", bgLight: "bg-emerald-50", type: "savings" },
            "Repair & Maintenance": { icon: "fa-tools", color: "bg-gray-500", text: "text-gray-500", bgLight: "bg-gray-100", type: "needs" },
            "Travel & Tour": { icon: "fa-plane", color: "bg-sky-500", text: "text-sky-500", bgLight: "bg-sky-50", type: "wants" },
            "Unexpected / Emergency": { icon: "fa-exclamation-triangle", color: "bg-red-600", text: "text-red-600", bgLight: "bg-red-50", type: "savings" },
            "Salary": { icon: "fa-money-bill", color: "bg-emerald-500", text: "text-emerald-500", bgLight: "bg-emerald-50" },
            "Business": { icon: "fa-briefcase", color: "bg-blue-600", text: "text-blue-600", bgLight: "bg-blue-50" },
            "Gift": { icon: "fa-gift", color: "bg-pink-500", text: "text-pink-500", bgLight: "bg-pink-50" },
            "Bonus": { icon: "fa-star", color: "bg-yellow-500", text: "text-yellow-500", bgLight: "bg-yellow-50" },
            "Loan Taken": { icon: "fa-hand-holding-usd", color: "bg-orange-500", text: "text-orange-500", bgLight: "bg-orange-50" },
            "Other": { icon: "fa-shapes", color: "bg-slate-500", text: "text-slate-500", bgLight: "bg-slate-50" }
        };

        const expenseCats = Object.keys(catConfig).filter(k => catConfig[k].type);
        const incomeCats = ["Salary", "Business", "Gift", "Bonus", "Loan Taken", "Other"];
        const formatter = new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0 });

        // --- 2. GLOBAL UTILITIES (DEFINED FIRST) ---
        function saveData() { localStorage.setItem('transactions', JSON.stringify(transactions)); updateUI(); }
        
        function getLocalDate() {
            const d = new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function setupDates() {
            const today = getLocalDate();
            const txDate = document.getElementById('tx-date');
            const udharDate = document.getElementById('udhar-date');
            if(txDate) { txDate.value = today; highlightDate(txDate); }
            if(udharDate) { udharDate.value = today; highlightDate(udharDate); }
            const yrSelect = document.getElementById('filter-year-input');
            const currentYear = new Date().getFullYear();
            if(yrSelect) {
                yrSelect.innerHTML = '';
                for(let i=0; i<5; i++) { 
                    const opt = document.createElement('option'); 
                    opt.value = currentYear - i; 
                    opt.text = currentYear - i; 
                    yrSelect.appendChild(opt); 
                }
                // Set default value for Year select
                yrSelect.value = currentYear;
            }
        }
        
        function setToday(inputId) { const today = getLocalDate(); const el = document.getElementById(inputId); if(el) { el.value = today; highlightDate(el); } }
        
        function highlightDate(el) { 
            if(!el) return; 
            const today = getLocalDate();
            const isUdhar = el.id.includes('udhar'); 
            const activeColor = isUdhar?'border-blue-500':'border-teal-500'; 
            const activeBg = isUdhar?'bg-white':'bg-slate-50'; 
            const baseBorder = isUdhar?'border-slate-200':'border-slate-200'; 
            const baseBg = isUdhar?'bg-white':'bg-white'; 
            if(el.value === today) { el.classList.add(activeColor, activeBg); el.classList.remove(baseBorder, baseBg); } 
            else { el.classList.remove(activeColor, activeBg); el.classList.add(baseBorder, baseBg); } 
        }

        function populateBudgetCatSelect() { const sel = document.getElementById('budget-cat-select'); if(!sel) return; sel.innerHTML = ''; expenseCats.forEach(cat => { const opt = document.createElement('option'); opt.value = cat; opt.innerText = cat; sel.appendChild(opt); }); }
        function populateCats(cats) { const sel = document.getElementById('tx-category'); if(!sel) return; sel.innerHTML = ''; cats.forEach(c => { const opt = document.createElement('option'); opt.value = c; opt.innerText = c; sel.appendChild(opt); }); }
        
        // --- ADDED THIS FUNCTION TO FIX "ADD CUSTOMER" CLICK ISSUE ---
        function updateDatalist() {
             const dl = document.getElementById('udhar-names-list');
             if(!dl) return;
             dl.innerHTML = '';
             const uniqueNames = [...new Set(transactions.filter(t=>t.person).map(t=>t.person))];
             uniqueNames.forEach(n => {
                 const opt = document.createElement('option');
                 opt.value = n;
                 dl.appendChild(opt);
             });
        }

        // --- UPDATED BALANCE CALCULATION FOR KHATA BOOK ---
        function calculateBalance(person) { 
            let bal = 0; 
            transactions.forEach(t => { 
                if(t.person !== person) return; 
                // Logic: Given = +, Taken = -
                if(t.type === 'udhar') { 
                    if(t.loanType === 'given') bal += t.amount; 
                    else bal -= t.amount; // Taken
                } 
                // Settlement/Wusool Logic
                // If I received money (income), it reduces what I gave (Receivable decreases)
                // If I paid money (expense), it reduces what I took (Payable decreases)
                else if (t.isWusool) { 
                    if(t.type === 'income') bal -= t.amount; // Received cash
                    else if(t.type === 'expense') bal += t.amount; // Paid cash
                } 
            }); 
            return bal; 
        }
        
        // FIXED: Robust Filtering Logic including Custom Date Range
        function getFilteredTransactions() {
            return transactions.filter(t => {
                // 1. Filter by Transaction Type (All/Debit/Credit)
                if(filterState.txType === 'expense' && t.type !== 'expense') return false;
                if(filterState.txType === 'income' && t.type !== 'income') return false;
                
                // 2. Filter by Time Period
                if(filterState.type === 'month') {
                    return t.date && t.date.startsWith(filterState.month);
                }
                if(filterState.type === 'year') {
                    return t.date && t.date.startsWith(filterState.year.toString());
                }
                if(filterState.type === 'custom') {
                    if(!filterState.start || !filterState.end) return true;
                    return t.date >= filterState.start && t.date <= filterState.end;
                }
                return true;
            });
        }

        // New function for running balance map
        function getRunningBalances() {
            // Sort by date ascending to calculate running total (Oldest First for Calculation)
            const sorted = [...transactions].sort((a, b) => new Date(a.date) - new Date(b.date) || a.id - b.id);
            const balMap = {};
            let currentBal = 0;
            sorted.forEach(t => {
                let change = 0;
                if(t.type === 'income') change = t.amount;
                else if(t.type === 'expense') change = -t.amount;
                else if(t.type === 'udhar') {
                    // Loan Taken = Income flow (Wallet increases)
                    if(t.loanType === 'taken') change = t.amount; 
                    // Loan Given = Expense flow (Wallet decreases)
                    else change = -t.amount; 
                }
                
                currentBal += change;
                balMap[t.id] = currentBal;
            });
            return balMap;
        }

        function initFilterUI() {
            const mInput = document.getElementById('filter-month-input');
            const yInput = document.getElementById('filter-year-input');
            const typeInput = document.getElementById('filter-type');
            const startInput = document.getElementById('filter-start-date');
            const endInput = document.getElementById('filter-end-date');
            
            // Re-calculate Local Time constants to be sure
            const d = new Date();
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const curMonth = `${y}-${m}`;
            const today = getLocalDate();

            // Set initial input values based on global state
            if(mInput) mInput.value = filterState.month;
            // Year input is populated by setupDates(), we just ensure value matches state
            if(yInput) yInput.value = filterState.year;
            if(startInput) startInput.value = filterState.start;
            if(endInput) endInput.value = filterState.end;
            
            if(typeInput) {
                typeInput.addEventListener('change', (e) => {
                    const type = e.target.value; 
                    filterState.type = type;
                    
                    // FORCE RESET TO CURRENT DATE ON TYPE CHANGE
                    const now = new Date();
                    const cy = now.getFullYear();
                    const cm = String(now.getMonth() + 1).padStart(2, '0');
                    const cMonthStr = `${cy}-${cm}`;
                    const cToday = getLocalDate();

                    if(type === 'month') {
                        filterState.month = cMonthStr;
                        if(mInput) mInput.value = cMonthStr;
                    } else if(type === 'year') {
                        filterState.year = cy;
                        if(yInput) yInput.value = cy;
                    } else if(type === 'custom') {
                        filterState.start = cToday;
                        filterState.end = cToday;
                        if(startInput) startInput.value = cToday;
                        if(endInput) endInput.value = cToday;
                    }

                    // Toggle Visibility
                    if(mInput) mInput.classList.toggle('hidden', type !== 'month');
                    if(yInput) yInput.classList.toggle('hidden', type !== 'year');
                    if(document.getElementById('custom-date-range')) document.getElementById('custom-date-range').classList.toggle('hidden', type !== 'custom');
                    
                    renderFullList();
                });
            }

            // Listeners for specific inputs to update state immediately
            if(mInput) mInput.addEventListener('change', (e) => { filterState.month = e.target.value; renderFullList(); });
            if(yInput) yInput.addEventListener('change', (e) => { filterState.year = e.target.value; renderFullList(); });
            if(startInput) startInput.addEventListener('change', (e) => { filterState.start = e.target.value; renderFullList(); });
            if(endInput) endInput.addEventListener('change', (e) => { filterState.end = e.target.value; renderFullList(); });
        }

        function setHistoryFilter(type) {
            filterState.txType = type;
            const btnAll = document.getElementById('hf-all');
            const btnExp = document.getElementById('hf-expense');
            const btnInc = document.getElementById('hf-income');
            if(btnAll) btnAll.className = `flex-1 py-2 rounded-lg transition-all ${type === 'all' ? 'bg-white shadow-sm text-slate-800' : 'text-slate-500 hover:text-slate-700'}`;
            if(btnExp) btnExp.className = `flex-1 py-2 rounded-lg transition-all ${type === 'expense' ? 'bg-white shadow-sm text-rose-600' : 'text-slate-500 hover:text-rose-600'}`;
            if(btnInc) btnInc.className = `flex-1 py-2 rounded-lg transition-all ${type === 'income' ? 'bg-white shadow-sm text-emerald-600' : 'text-slate-500 hover:text-emerald-600'}`;
            renderFullList();
        }

        // --- 3. CORE LOGIC (UI UPDATES) ---
        function switchView(view) {
            ['home', 'report', 'udhar', 'settings', 'budget'].forEach(v => {
                document.getElementById('view-'+v).classList.add('hidden');
                document.getElementById('nav-'+v).classList.remove('active', 'text-teal-600');
                if(v !== view) document.getElementById('nav-'+v).classList.add('text-slate-300');
            });
            document.getElementById('view-'+view).classList.remove('hidden');
            const nav = document.getElementById('nav-'+view);
            nav.classList.add('active', 'text-teal-600');
            nav.classList.remove('text-slate-300');
            currentView = view;
            if(view === 'home') updateChart();
            if(view === 'report') renderFullList();
            if(view === 'udhar') renderCustomerList();
            if(view === 'budget') calculateBudget();
        }

        function updateUI() {
            let cash = 0, bank = 0, udhar = 0;
            transactions.forEach(t => {
                if(t.type === 'income') t.account === 'Cash' ? cash += t.amount : bank += t.amount;
                else if(t.type === 'expense') t.account === 'Cash' ? cash -= t.amount : bank -= t.amount;
                else if(t.type === 'transfer') {
                     if(t.desc === 'Cash' && t.account === 'Bank') { bank -= t.amount; cash += t.amount; } 
                     else if(t.desc === 'Bank' && t.account === 'Cash') { cash -= t.amount; bank += t.amount; }
                }
                else if(t.type === 'udhar') {
                    if (t.loanType === 'taken') t.account === 'Cash' ? cash += t.amount : bank += t.amount;
                    else { 
                        if (t.status !== 'settled') udhar += t.amount; 
                        t.account === 'Cash' ? cash -= t.amount : bank -= t.amount; 
                    }
                }
            });

            let flowIncome = 0, flowExpense = 0, openingBalance = 0;
            const today = getLocalDate();
            const currentMonth = today.slice(0, 7);
            const currentYear = new Date().getFullYear().toString();
            let start = "";
            if (homeFilterState.period === 'day') start = today;
            if (homeFilterState.period === 'month') start = currentMonth + "-01";
            if (homeFilterState.period === 'year') start = currentYear + "-01-01";

            transactions.forEach(t => {
                const isBefore = t.date < start;
                const isInPeriod = (homeFilterState.period === 'day' && t.date === today) || 
                                   (homeFilterState.period === 'month' && t.date.startsWith(currentMonth)) || 
                                   (homeFilterState.period === 'year' && t.date.startsWith(currentYear));

                if (isBefore) {
                     if (t.type === 'income') openingBalance += t.amount;
                     if (t.type === 'expense') openingBalance -= t.amount;
                     if (t.type === 'udhar') { if (t.loanType === 'taken') openingBalance += t.amount; else openingBalance -= t.amount; }
                }

                if (isInPeriod) {
                    if (t.type === 'income' && !t.isWusool) flowIncome += t.amount;
                    if (t.type === 'expense') flowExpense += t.amount;
                }
            });

            const net = flowIncome - flowExpense;
            const tbEl = document.getElementById('total-balance');
            if(tbEl) {
                tbEl.innerText = formatter.format(net);
                tbEl.className = net >= 0 ? "text-xl font-bold text-emerald-600" : "text-xl font-bold text-rose-600";
            }
            if(document.getElementById('cash-balance')) document.getElementById('cash-balance').innerText = formatter.format(cash);
            if(document.getElementById('bank-balance')) document.getElementById('bank-balance').innerText = formatter.format(bank);
            if(document.getElementById('udhar-balance')) document.getElementById('udhar-balance').innerText = formatter.format(udhar);
            
            if(document.getElementById('total-income')) document.getElementById('total-income').innerText = formatter.format(flowIncome);
            if(document.getElementById('total-expense')) document.getElementById('total-expense').innerText = formatter.format(flowExpense);
            
            const obContainer = document.getElementById('opening-balance-container');
            if(obContainer) {
                if(homeFilterState.period === 'month') {
                    obContainer.classList.remove('hidden');
                    document.getElementById('opening-balance-val').innerText = formatter.format(openingBalance);
                } else {
                    obContainer.classList.add('hidden');
                }
            }
            if(currentView === 'home') updateChart();
        }

        function setHomeFilter(period) {
            homeFilterState.period = period;
            ['day', 'month', 'year'].forEach(p => {
                const btn = document.getElementById(`hf-${p}`);
                if(btn) btn.className = p === period ? "flex-1 py-2 text-xs font-bold rounded-lg transition-all bg-white shadow-sm text-teal-700" : "flex-1 py-2 text-xs font-bold rounded-lg transition-all text-slate-500";
            });
            const map = { 'day': 'Today', 'month': 'Mo', 'year': 'Yr' };
            if(document.getElementById('lbl-income')) document.getElementById('lbl-income').innerText = `Income (${map[period]})`;
            if(document.getElementById('lbl-expense')) document.getElementById('lbl-expense').innerText = `Expense (${map[period]})`;
            if(document.getElementById('analysis-period-lbl')) document.getElementById('analysis-period-lbl').innerText = period === 'day' ? '(Today)' : (period === 'month' ? '(This Month)' : '(This Year)');
            const balMap = { 'day': 'Net (Today)', 'month': 'Net (Month)', 'year': 'Net (Year)' };
            if(document.getElementById('net-balance-label')) document.getElementById('net-balance-label').innerText = balMap[period];
            updateUI();
        }

        // --- 4. FEATURE: BUDGET ---
        function calculateBudget() {
            const currentMonth = new Date().toISOString().slice(0,7);
            const salary = transactions.filter(t => t.type === 'income' && t.desc === 'Salary' && t.date.startsWith(currentMonth)).reduce((sum, t) => sum + t.amount, 0);
            
            const disp = document.getElementById('budget-salary-display');
            if(disp) disp.innerText = formatter.format(salary);
            
            const sectionTotals = { needs: 0, wants: 0, savings: 0 };
            const catTotals = {};

            transactions.filter(t => t.type === 'expense' && t.date.startsWith(currentMonth)).forEach(t => {
                const conf = catConfig[t.desc];
                if(conf && conf.type) {
                    sectionTotals[conf.type] += t.amount;
                    if(!catTotals[t.desc]) catTotals[t.desc] = 0;
                    catTotals[t.desc] += t.amount;
                }
            });

            // 50/30/20 Rule
            const limits = {
                needs: salary * 0.50,
                wants: salary * 0.30,
                savings: salary * 0.20
            };

            ['needs', 'wants', 'savings'].forEach(type => {
                const spent = sectionTotals[type];
                const limit = limits[type];
                const bar = document.getElementById(`bar-${type}`);
                const valEl = document.getElementById(`budget-${type}-val`);
                const limEl = document.getElementById(`budget-${type}-limit`);
                const remEl = document.getElementById(`budget-${type}-rem`);
                const listEl = document.getElementById(`list-${type}`);
                const alertEl = document.getElementById(`alert-${type}`);

                if(valEl) valEl.innerText = formatter.format(spent);
                
                if(limEl) {
                    if (type === 'savings') {
                         limEl.innerText = `Target: ${formatter.format(limit)}`;
                    } else {
                         limEl.innerText = `Limit: ${formatter.format(limit)}`;
                    }
                }
                
                if(remEl) {
                     const remaining = limit - spent;
                     if (type === 'savings') {
                         remEl.innerText = `Baqi: ${formatter.format(remaining)}`; 
                         remEl.className = "text-[10px] font-bold text-slate-400";
                     } else {
                         if (remaining >= 0) {
                             remEl.innerText = `Baqi: ${formatter.format(remaining)}`;
                             remEl.className = "text-[10px] font-bold text-emerald-600";
                         } else {
                             remEl.innerText = `Extra: ${formatter.format(Math.abs(remaining))}`;
                             remEl.className = "text-[10px] font-bold text-rose-500";
                         }
                     }
                }

                if(bar) {
                    let pct = limit > 0 ? (spent/limit)*100 : 0;
                    if(pct > 100) pct = 100;
                    bar.style.width = `${pct}%`;
                    if(type !== 'savings' && limit > 0 && spent > limit) {
                        bar.classList.add('bg-rose-500');
                        if(alertEl) alertEl.classList.remove('hidden');
                    } else {
                        bar.classList.remove('bg-rose-500');
                        if(alertEl) alertEl.classList.add('hidden');
                    }
                }

                if(listEl) {
                    listEl.innerHTML = '';
                    Object.keys(catTotals).filter(c => catConfig[c].type === type).forEach(c => {
                         listEl.innerHTML += `<div class="flex justify-between text-xs text-slate-600 mt-1"><span>${c}</span><span>${formatter.format(catTotals[c])}</span></div>`;
                    });
                }
            });

            // Custom Budgets
            const customList = document.getElementById('custom-budgets-list');
            if(customList) {
                customList.innerHTML = '';
                for(const [cat, limit] of Object.entries(categoryLimits)) {
                    const spent = transactions.filter(t => t.type === 'expense' && t.desc === cat && t.date.startsWith(currentMonth)).reduce((sum,t)=>sum+t.amount,0);
                    const rem = limit - spent;
                    let pct = limit > 0 ? (spent/limit)*100 : 0; if(pct>100) pct=100;
                    let status = rem >= 0 ? `<span class="text-emerald-600">Baqi: ${formatter.format(rem)}</span>` : `<span class="text-rose-500">Extra: ${formatter.format(Math.abs(rem))}</span>`;
                    
                    customList.innerHTML += `
                    <div class="bg-white p-3 rounded-xl border border-slate-100 shadow-sm relative">
                        <button onclick="removeCategoryLimit('${cat}')" class="absolute top-2 right-2 text-slate-300"><i class="fas fa-times"></i></button>
                        <div class="flex justify-between items-center mb-1"><span class="font-bold text-xs">${cat}</span><span class="font-bold text-xs">${formatter.format(spent)} / ${formatter.format(limit)}</span></div>
                        <div class="w-full h-1.5 bg-slate-100 rounded-full"><div class="h-full ${rem<0?'bg-rose-500':'bg-teal-500'}" style="width:${pct}%"></div></div>
                        <p class="text-[9px] text-right mt-1 font-bold">${status}</p>
                    </div>`;
                }
            }
        }

        // --- 5. FEATURE: UDHAR (KHATA BOOK STYLE) ---
        
        function saveUdharTransaction() {
            const amt = parseFloat(document.getElementById('udhar-amount').value);
            const name = document.getElementById('udhar-person').value;
            const phone = document.getElementById('udhar-phone').value;
            const acc = document.getElementById('udhar-source').value;
            const date = document.getElementById('udhar-date').value;
            const rDate = document.getElementById('udhar-return-date').value;
            const type = document.getElementById('loan-type').value; 

            if(!amt || !name) return alert("Amount and Name required");
            
            // Logic for Messages Reverted to Scenario 1-8
            const oldBal = calculateBalance(name);
            const amtFmt = formatter.format(amt).replace('₹','').trim();
            const balAfter = type === 'given' ? oldBal + amt : oldBal - amt;
            const balFmt = formatter.format(Math.abs(balAfter)).replace('₹','').trim();
            const oldFmt = formatter.format(Math.abs(oldBal)).replace('₹','').trim();
            
            let msg = "";
            // Logic restoration
            if (type === 'taken') { // I TOOK (Payable increases or Receivable decreases)
                if (oldBal < 0) { // Scenario 2: Already owed money, took more
                     msg = `${name}, Pehle se ₹${oldFmt} udhaar the. Aaj ₹${amtFmt} aur udhaar liye gaye hain. Ab total udhaar ₹${balFmt} ho gaya hai. Jald hi wapas kar diya jayega. Thank you.`;
                } else if (oldBal > 0) { // Scenario 5/6 (Wusool/Return): I gave money before, now taking back (receiving)
                     if(Math.abs(balAfter) < 1) { // Scenario 6: Cleared
                         msg = `${name}, Aaj aap ne ₹${amtFmt} wapas kiye hain. Is ke sath hi aapka poora hisaab clear ho gaya hai. Ab koi raqam baqi nahi rahi. Thank you.`;
                     } else { // Scenario 5: Partial
                         msg = `${name}, Aaj aap ne ₹${amtFmt} wapas kiye hain. Abhi baqi ₹${balFmt} reh gaye hain. Unko bhi jald wapas karne ki koshish karein. Thank you.`;
                     }
                } else { // Scenario 1: New debt
                    msg = `${name}, Aaj aap se ₹${amtFmt} udhaar liye gaye hain. Jald hi wapas karne ki koshish ki jayegi. Thank you.`;
                }
            } else { // I GAVE (Receivable increases or Payable decreases)
                if (oldBal > 0) { // Scenario 4: Already gave money, giving more
                    msg = `${name}, Aapne pehle se ₹${oldFmt} liye hue the. Aaj ₹${amtFmt} aur udhaar liye hain. Ab total udhaar ₹${balFmt} ho gaye hain. Jald hi wapas karne ki koshish karein. Thank you.`;
                } else if (oldBal < 0) { // Scenario 7/8 (Wusool/Return): I owed money, now returning (paying)
                    if(Math.abs(balAfter) < 1) { // Scenario 8: Cleared
                         msg = `${name}, Aaj maine aapko ₹${amtFmt} wapas kiye hain. Ab koi bhi raqam baqi nhi hai aap ka hisab clear ho gya hai. Thank you.`;
                    } else { // Scenario 7: Partial
                         msg = `${name}, Aaj maine aapko ₹${amtFmt} wapas kiye hain. Abhi baqi ₹${balFmt} reh gaye hain. Unko bhi jald wapas karne ki koshish karunga. Thank you.`;
                    }
                } else { // Scenario 3: New loan
                    msg = `${name}, Aapne ₹${amtFmt} udhaar liye hain. Please ${rDate?rDate:'jald'} tak wapas karne ki koshish karein. Thank you.`;
                }
            }

            // Determine entry type details
            // If type is 'taken' (I GOT), if oldBal > 0 it is income (recovery), else it is loan taken (income)
            // Actually simplistically:
            // I Give Money -> Expense (or Asset Inc)
            // I Take Money -> Income (or Liability Inc)
            // But for tracking flow:
            // If I give money to someone who owes me -> Loan Given (Asset Increase) -> Expense flow for wallet
            // If I give money to someone I owe -> Loan Repayment (Liability Decrease) -> Expense flow for wallet
            // In both cases "Maine Diye" reduces my wallet -> Expense type logic for cashflow
            
            // If I take money from someone I owe -> Loan Taken (Liability Increase) -> Income flow
            // If I take money from someone who owes me -> Loan Recovery (Asset Decrease) -> Income flow
            // In both cases "Maine Liye" increases my wallet -> Income type logic for cashflow

            const isRecovery = (type === 'taken' && oldBal > 0);
            const isRepayment = (type === 'given' && oldBal < 0);
            
            const entry = {
                id: Date.now(),
                date: date,
                amount: amt,
                type: 'udhar',
                loanType: type, // 'given' or 'taken'
                person: name,
                phone: phone,
                account: acc,
                returnDate: rDate,
                desc: type === 'taken' ? (isRecovery ? `Udhar Wapas Mila: ${name}` : `Loan taken: ${name}`) : (isRepayment ? `Repayment: ${name}` : `Loan given: ${name}`),
                status: 'active',
                isWusool: isRecovery || isRepayment // Mark as settlement/wusool if applicable
            };
            
            transactions.push(entry);
            saveData();
            closeUdharModal();
            renderCustomerList();
            
            // Clear inputs
            document.getElementById('udhar-amount').value = '';
            
            if(phone) {
                const cleanPhone = phone.replace(/\D/g, '');
                const finalPhone = cleanPhone.length === 10 ? '91'+cleanPhone : cleanPhone;
                window.open(`https://wa.me/${finalPhone}?text=${encodeURIComponent(msg)}`, '_blank');
            }
        }

        // --- 6. SETUP & HELPERS ---
        
        async function pickContact() {
            // Try Native API first
            if ('contacts' in navigator && 'ContactsManager' in window) {
                try {
                    const props = ['name', 'tel'];
                    const opts = { multiple: false };
                    const contacts = await navigator.contacts.select(props, opts);
                    if (contacts.length) {
                        const contact = contacts[0];
                        document.getElementById('udhar-person').value = contact.name[0];
                        if (contact.tel && contact.tel.length) {
                            // Basic cleaning, assuming Indian context often has spaces or dashes
                            document.getElementById('udhar-phone').value = contact.tel[0].replace(/\D/g, ''); 
                        }
                        return; // Success
                    }
                } catch (ex) {
                    // Fallback to internal list if cancelled or failed
                    console.log("Native contact picker failed/cancelled:", ex);
                }
            }
            
            // Fallback: Simple simulation of contact picker since native API isn't always available/easy
            const modal = document.getElementById('contacts-modal');
            const list = document.getElementById('contacts-list-content');
            if(!modal || !list) return;
            
            list.innerHTML = '';
            const contacts = [...new Set(transactions.filter(t=>t.person).map(t=>t.person))];
            
            if(contacts.length === 0) {
                 list.innerHTML = '<p class="text-xs text-slate-400 text-center">No recent app contacts found.</p>';
            } else {
                contacts.forEach(c => {
                    const btn = document.createElement('button');
                    btn.className = "w-full text-left p-3 rounded-lg bg-slate-50 hover:bg-slate-100 text-sm font-bold text-slate-700 border border-slate-100";
                    btn.innerText = c;
                    btn.onclick = () => {
                        document.getElementById('udhar-person').value = c;
                        const existing = transactions.find(t => t.person === c && t.phone);
                        if(existing) document.getElementById('udhar-phone').value = existing.phone || '';
                        modal.classList.add('hidden');
                    };
                    list.appendChild(btn);
                });
            }
            modal.classList.remove('hidden');
        }

        function openEntryModal() {
            editingTransactionId = null;
            document.getElementById('entry-modal-title').innerText = "New Entry";
            document.getElementById('save-btn-text').innerText = "Save Transaction";
            setTxType('expense');
            document.getElementById('tx-amount').value = '';
            document.getElementById('tx-note').value = '';
            setToday('tx-date');
            document.getElementById('entry-modal').classList.remove('hidden');
        }
        function closeEntryModal() { document.getElementById('entry-modal').classList.add('hidden'); }
        
        function openNewUdharModal() {
            setToday('udhar-date');
            setLoanType('given'); // Default to giving
            updateDatalist();
            document.getElementById('udhar-amount').value = ''; 
            document.getElementById('udhar-modal').classList.remove('hidden');
        }
        function closeUdharModal() { document.getElementById('udhar-modal').classList.add('hidden'); }

        function setTxType(type) {
            document.getElementById('tx-type').value = type;
            const btnExp = document.getElementById('btn-expense');
            const btnInc = document.getElementById('btn-income');
            const btnTrans = document.getElementById('btn-transfer'); 
            
            const allBtns = [btnExp, btnInc, btnTrans];
            allBtns.forEach(b => { if(b) b.className = "flex-1 py-3 rounded-lg text-slate-400"; });

            if(type==='expense'){ 
                if(btnExp) btnExp.className="flex-1 py-3 rounded-lg shadow-sm bg-white text-rose-600"; 
                populateCats(expenseCats);
                document.getElementById('cat-wrapper').classList.remove('hidden');
                document.getElementById('account-wrapper').classList.remove('hidden');
                document.getElementById('transfer-wrapper').classList.add('hidden');
                document.getElementById('transfer-wrapper').classList.remove('flex');
            } else if (type==='income') {
                if(btnInc) btnInc.className="flex-1 py-3 rounded-lg shadow-sm bg-white text-emerald-600";
                populateCats(incomeCats);
                document.getElementById('cat-wrapper').classList.remove('hidden');
                document.getElementById('account-wrapper').classList.remove('hidden');
                document.getElementById('transfer-wrapper').classList.add('hidden');
                document.getElementById('transfer-wrapper').classList.remove('flex');
            } else { 
                if(btnTrans) btnTrans.className="flex-1 py-3 rounded-lg shadow-sm bg-white text-blue-600";
                document.getElementById('cat-wrapper').classList.add('hidden');
                document.getElementById('account-wrapper').classList.add('hidden');
                document.getElementById('transfer-wrapper').classList.remove('hidden');
                document.getElementById('transfer-wrapper').classList.add('flex');
            }
        }
        function setLoanType(type) { 
            document.getElementById('loan-type').value = type; 
            const btnGiven = document.getElementById('btn-loan-given'); 
            const btnTaken = document.getElementById('btn-loan-taken'); 
            
            // Highlight logic
            if (type === 'given') { 
                btnGiven.className = "flex-1 py-4 rounded-xl border border-rose-600 bg-rose-100 text-rose-700 font-bold flex flex-col items-center gap-1 shadow-inner"; 
                btnTaken.className = "flex-1 py-4 rounded-xl border border-emerald-100 bg-emerald-50 text-emerald-600 font-bold flex flex-col items-center gap-1 opacity-60"; 
                document.getElementById('save-udhar-btn-text').innerText = "Save (I GAVE)"; 
            } else { 
                btnTaken.className = "flex-1 py-4 rounded-xl border border-emerald-600 bg-emerald-100 text-emerald-700 font-bold flex flex-col items-center gap-1 shadow-inner"; 
                btnGiven.className = "flex-1 py-4 rounded-xl border border-rose-100 bg-rose-50 text-rose-600 font-bold flex flex-col items-center gap-1 opacity-60"; 
                document.getElementById('save-udhar-btn-text').innerText = "Save (I GOT)"; 
            } 
        }

        // Smart Transfer Auto-Switch
        function syncTransferDest() {
            const fromVal = document.getElementById('transfer-from').value;
            const toEl = document.getElementById('transfer-to');
            if(fromVal === 'Cash') toEl.value = 'Bank';
            else if(fromVal === 'Bank') toEl.value = 'Cash';
        }

        function saveTransaction() {
            const type = document.getElementById('tx-type').value;
            const amt = parseFloat(document.getElementById('tx-amount').value);
            const date = document.getElementById('tx-date').value;
            const note = document.getElementById('tx-note').value;
            
            if(!amt) return alert("Amount required");
            
            let entry = { id: Date.now(), date, amount: amt, type, note };

            if (type === 'transfer') {
                const fromAcc = document.getElementById('transfer-from').value;
                const toAcc = document.getElementById('transfer-to').value;
                if (fromAcc === toAcc) return alert("Source and Destination accounts cannot be the same.");
                entry.account = fromAcc; 
                entry.desc = toAcc; 
                entry.category = "Transfer";
            } else {
                entry.desc = document.getElementById('tx-category').value;
                entry.account = document.getElementById('tx-account').value;
            }
            
            if (editingTransactionId) {
                const idx = transactions.findIndex(t => t.id === editingTransactionId);
                if (idx !== -1) { 
                    transactions[idx] = { ...transactions[idx], ...entry };
                }
            } else {
                transactions.push(entry);
            }
            
            saveData();
            closeEntryModal();
            
            // Clear Inputs for Next Use
            document.getElementById('tx-amount').value = '';
            document.getElementById('tx-note').value = '';
        }

        function updateChart() { 
            if(document.getElementById('view-home').classList.contains('hidden')) return; 
            const ctx = document.getElementById('expenseChart').getContext('2d'); 
            const legendContainer = document.getElementById('analysis-legend'); 
            const expenses = {}; 
            const today = getLocalDate();
            const currentMonth = today.slice(0, 7);
            const currentYear = new Date().getFullYear().toString();
            
            const expenseTx = transactions.filter(t => {
                if (t.type !== 'expense') return false;
                if (homeFilterState.period === 'day') return t.date === today;
                if (homeFilterState.period === 'month') return t.date.startsWith(currentMonth);
                if (homeFilterState.period === 'year') return t.date.startsWith(currentYear);
                return true;
            });
    
            const totalExpense = expenseTx.reduce((sum, t) => sum + t.amount, 0); 
            expenseTx.forEach(t => { expenses[t.desc] = (expenses[t.desc] || 0) + t.amount; }); 
            if(document.getElementById('chart-total-center')) document.getElementById('chart-total-center').innerText = formatter.format(totalExpense); 
            
            if(chartInstance) chartInstance.destroy(); 
            chartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(expenses), datasets: [{ data: Object.values(expenses), backgroundColor: ['#f43f5e', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#6366f1', '#14b8a6'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { display: false } } } }); 
            
            if(legendContainer) {
                legendContainer.innerHTML = ''; 
                Object.entries(expenses).sort((a,b) => b[1] - a[1]).forEach(([cat, amount]) => { 
                    const percent = totalExpense > 0 ? ((amount / totalExpense) * 100).toFixed(1) : 0; 
                    const cfg = catConfig[cat] || {icon: "fa-circle", color: "bg-slate-400", text: "text-slate-400", bgLight: "bg-slate-100"}; 
                    legendContainer.innerHTML += `<div class="flex justify-between items-center text-sm group"><div class="flex items-center gap-3"><div class="w-9 h-9 rounded-full ${cfg.bgLight} ${cfg.text} flex items-center justify-center shadow-sm border border-slate-50"><i class="fas ${cfg.icon} text-xs"></i></div><div><p class="font-bold text-slate-700 text-xs">${cat}</p><div class="w-24 h-1.5 bg-slate-100 rounded-full mt-1 overflow-hidden"><div class="h-full ${cfg.color} rounded-full" style="width: ${percent}%"></div></div></div></div><div class="text-right"><p class="font-bold text-slate-800 text-xs">${formatter.format(amount)}</p><p class="text-[10px] text-slate-400 font-bold">${percent}%</p></div></div>`; 
                }); 
            }
        }

        function showSummary(type) {
            const modal = document.getElementById('summary-modal');
            const title = document.getElementById('summary-title');
            const content = document.getElementById('summary-content');
            if(!modal || !title || !content) return;
            
            const today = getLocalDate();
            const currentMonth = today.slice(0, 7);
            const currentYear = new Date().getFullYear().toString();
            
            const filtered = transactions.filter(t => {
                if (t.type !== type) return false;
                if (homeFilterState.period === 'day') return t.date === today;
                if (homeFilterState.period === 'month') return t.date.startsWith(currentMonth);
                if (homeFilterState.period === 'year') return t.date.startsWith(currentYear);
                return true;
            });
            
            const total = filtered.reduce((sum, t) => sum + t.amount, 0);
            const categories = {};
            filtered.forEach(t => { 
                const catName = t.desc || 'Other';
                categories[catName] = (categories[catName] || 0) + t.amount; 
            });
            
            title.innerText = type === 'income' ? 'Income Breakdown' : 'Expense Breakdown';
            title.className = `font-bold text-lg ${type === 'income' ? 'text-emerald-700' : 'text-rose-700'}`;
            
            if (filtered.length === 0) {
                content.innerHTML = '<p class="text-center text-xs text-slate-400 py-8">No records found for this period.</p>';
            } else {
                let html = `<div class="mb-4 text-center bg-slate-50 p-4 rounded-xl border border-slate-100">
                    <p class="text-[10px] text-slate-400 uppercase tracking-widest font-bold mb-1">Total (${homeFilterState.period})</p>
                    <h2 class="text-3xl font-bold ${type === 'income' ? 'text-emerald-600' : 'text-rose-600'}">${formatter.format(total)}</h2>
                </div><ul class="space-y-3">`;
                
                Object.entries(categories).sort((a,b) => b[1] - a[1]).forEach(([cat, amount]) => {
                    const percent = total > 0 ? ((amount / total) * 100).toFixed(1) : 0;
                    const cfg = catConfig[cat] || {icon: "fa-circle", color: "bg-slate-400", text: "text-slate-400", bgLight: "bg-slate-100"};
                    html += `
                    <li class="flex justify-between items-center text-sm">
                        <div class="flex items-center gap-3">
                            <div class="w-9 h-9 rounded-full ${cfg.bgLight} ${cfg.text} flex items-center justify-center text-xs shadow-sm border border-slate-50"><i class="fas ${cfg.icon} text-xs"></i></div>
                            <div>
                                <span class="font-bold text-slate-700 text-xs block">${cat}</span>
                                <div class="w-16 h-1 bg-slate-100 rounded-full mt-1"><div class="h-full ${cfg.color}" style="width:${percent}%"></div></div>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-slate-800 text-xs">${formatter.format(amount)}</p>
                            <p class="text-[10px] text-slate-400 font-bold">${percent}%</p>
                        </div>
                    </li>`;
                });
                html += '</ul>';
                content.innerHTML = html;
            }
            modal.classList.remove('hidden');
        }

        function editTransaction(id) {
            const t = transactions.find(tx => tx.id === id);
            if (!t) return;
            if(t.type === 'udhar' || t.type.includes('Recovery') || t.isWusool) {
                 openNewUdharModal(); 
                 editingTransactionId = id; 
                 document.getElementById('udhar-modal-title').innerText = "Edit Loan";
                 if (t.loanType === 'taken') setLoanType('taken'); else setLoanType('given');
                 document.getElementById('udhar-amount').value = t.amount;
                 document.getElementById('udhar-person').value = t.person;
                 document.getElementById('udhar-phone').value = t.phone || '';
                 document.getElementById('udhar-source').value = t.account;
                 document.getElementById('udhar-date').value = t.date;
                 document.getElementById('udhar-return-date').value = t.returnDate || '';
                 return; 
            }
            editingTransactionId = id;
            document.getElementById('entry-modal-title').innerText = "Edit Entry";
            document.getElementById('save-btn-text').innerText = "Update Transaction";
            setTxType(t.type);
            document.getElementById('tx-amount').value = t.amount;
            document.getElementById('tx-date').value = t.date;
            document.getElementById('tx-note').value = t.note || '';
            document.getElementById('tx-category').value = t.desc;
            document.getElementById('tx-account').value = t.account;
            document.getElementById('entry-modal').classList.remove('hidden');
        }

        function deleteTransaction(id) {
            if(!confirm("Delete this entry?")) return;
            transactions = transactions.filter(t => t.id !== id);
            saveData();
            if(currentView === 'report') renderFullList();
            if(currentView === 'udhar' && lastOpenedPerson) openPersonDetails(lastOpenedPerson);
            updateUI();
        }

        function exportData() { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(transactions)); const a = document.createElement('a'); a.href = dataStr; a.download = "backup.json"; a.click(); }
        function importData(input) { const reader = new FileReader(); reader.onload = function(e) { if(confirm("This will replace all current data. Are you sure?")) { transactions = JSON.parse(e.target.result); saveData(); alert("Data Restored!"); } }; reader.readAsText(input.files[0]); }
        function clearAll() { if(confirm("⚠️ Critical Warning:\nReset App?")) { transactions = []; saveData(); updateUI(); alert("Reset Done."); } }
        function exitApp() { if(confirm("Exit App?")) { window.close(); if(!window.closed) alert("Close tab manually."); } }

        function settleFull() {
            const pending = document.getElementById('wusool-amount').dataset.pending;
            if(pending && Math.abs(parseFloat(pending)) > 0) { document.getElementById('wusool-amount').value = Math.abs(parseFloat(pending)); } 
            else { alert("Nothing to settle."); }
        }

        function openWusoolForPerson(name, autoSettle = false) { 
            document.getElementById('person-history-modal').classList.add('hidden'); 
            let totalPending = calculateBalance(name);
            if(Math.abs(totalPending) <= 0.1 && !autoSettle) return alert("No pending balance."); 
            document.getElementById('wusool-person-name').value = name; 
            document.getElementById('wusool-msg').innerText = `Balance: ${formatter.format(totalPending)}`; 
            document.getElementById('wusool-amount').dataset.pending = totalPending; 
            if(autoSettle) { document.getElementById('wusool-amount').value = Math.abs(totalPending); } 
            else { document.getElementById('wusool-amount').value = ''; }
            document.getElementById('wusool-modal').classList.remove('hidden'); 
        }

        function giveMoreUdhar(name) { 
            document.getElementById('person-history-modal').classList.add('hidden');
            openNewUdharModal(); 
            document.getElementById('udhar-person').value = name; 
            const existing = transactions.find(t => t.person === name && t.phone); 
            if(existing) { document.getElementById('udhar-phone').value = existing.phone; }
            setLoanType('given');
        }

        // --- 7. MISSING FUNCTIONS (Restored) ---

        function renderFullList() {
            const list = document.getElementById('full-list');
            if(!list) return;
            list.innerHTML = '';
            
            // SORTING CHANGE: Date Descending, then ID Descending (Newest Entry Top)
            const filtered = getFilteredTransactions().sort((a,b) => new Date(b.date) - new Date(a.date) || b.id - a.id);
            const balances = getRunningBalances(); // Pre-calculate balances

            if(filtered.length === 0) {
                list.innerHTML = `<div class="p-8 text-center text-slate-400 text-xs">No records found matching filters.</div>`;
                return;
            }

            filtered.forEach(t => {
                const isExpense = t.type === 'expense';
                const isIncome = t.type === 'income';
                const color = isExpense ? 'text-rose-600' : (isIncome ? 'text-emerald-600' : 'text-slate-600');
                const icon = isExpense ? 'fa-arrow-up' : (isIncome ? 'fa-arrow-down' : 'fa-exchange-alt');
                const bg = isExpense ? 'bg-rose-50 text-rose-600' : (isIncome ? 'bg-emerald-50 text-emerald-600' : 'bg-slate-100 text-slate-500');
                
                let title = t.desc;
                let sub = t.account;
                if(t.type === 'udhar') {
                    title = t.desc; 
                    sub = t.person;
                }
                
                // Format Time from ID (Timestamp)
                const timeStr = new Date(t.id).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                
                // Get running balance for this specific transaction
                const runningBal = balances[t.id] !== undefined ? formatter.format(balances[t.id]) : '-';

                const li = document.createElement('li');
                li.className = "p-4 flex justify-between items-start hover:bg-slate-50 transition-colors border-b border-slate-50 last:border-0";
                
                li.innerHTML = `
                <div class="flex items-start gap-3 w-full overflow-hidden">
                    <div class="w-10 h-10 rounded-full ${bg} flex items-center justify-center text-sm shadow-sm border border-slate-100 shrink-0 mt-1">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start">
                            <p class="font-bold text-slate-800 text-sm leading-tight truncate pr-2">${title}</p>
                            <p class="font-bold ${color} text-sm shrink-0">${formatter.format(t.amount)}</p>
                        </div>
                        
                        ${t.note ? `<p class="text-[11px] text-slate-500 italic truncate mt-0.5"><i class="fas fa-sticky-note text-[9px] mr-1 opacity-70"></i>${t.note}</p>` : ''}
                        
                        <div class="flex items-center justify-between mt-1.5">
                            <div class="flex items-center gap-2">
                                <span class="text-[9px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded font-bold tracking-wide border border-slate-200">
                                    ${t.date} <span class="text-slate-300">|</span> ${timeStr}
                                </span>
                                <span class="text-[9px] text-slate-400 font-bold uppercase tracking-wider">${sub}</span>
                            </div>
                            <p class="text-[9px] text-slate-400 font-bold bg-slate-50 px-1.5 py-0.5 rounded border border-slate-100">Bal: ${runningBal}</p>
                        </div>

                        <div class="flex gap-4 justify-end mt-2 pt-2 border-t border-dashed border-slate-100">
                            <button onclick="editTransaction(${t.id})" class="text-[10px] text-blue-400 hover:text-blue-600 font-bold flex items-center gap-1"><i class="fas fa-pen"></i></button>
                            <button onclick="deleteTransaction(${t.id})" class="text-sm text-slate-300 hover:text-red-500 transition-colors p-1"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>`;
                list.appendChild(li);
            });
        }

        // RENDER KHATA BOOK CUSTOMER LIST
        function renderCustomerList() {
            const container = document.getElementById('udhar-list-container');
            const noMsg = document.getElementById('no-udhar-msg');
            if(!container) return;
            
            container.innerHTML = '';
            const people = [...new Set(transactions.filter(t => t.person).map(t => t.person))];
            
            let totalLene = 0;
            let totalDene = 0;
            let count = 0;

            people.forEach(p => {
                const bal = calculateBalance(p);
                // Even 0 balance people should show in ledger if needed, but for now hide inactive
                if(Math.abs(bal) < 1) return;
                
                count++;
                if(bal > 0) totalLene += bal;
                else totalDene += Math.abs(bal);
                
                const div = document.createElement('div');
                div.className = "bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex justify-between items-center active:scale-95 transition-transform cursor-pointer hover:bg-slate-50";
                div.onclick = () => openPersonDetails(p);
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-slate-100 text-slate-600 font-bold flex items-center justify-center border border-slate-200 text-sm">${p.charAt(0).toUpperCase()}</div>
                        <div>
                            <h4 class="font-bold text-slate-800 text-sm">${p}</h4>
                            <p class="text-[10px] text-slate-400 font-bold">Tap to view ledger</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-base ${bal > 0 ? 'text-emerald-600' : 'text-rose-600'}">₹${Math.abs(bal).toLocaleString()}</p>
                        <p class="text-[9px] ${bal > 0 ? 'text-emerald-600' : 'text-rose-600'} font-bold uppercase tracking-wide">${bal > 0 ? 'Lene Hain' : 'Dene Hain'}</p>
                    </div>
                `;
                container.appendChild(div);
            });

            document.getElementById('total-lene-hai').innerText = `₹${totalLene.toLocaleString()}`;
            document.getElementById('total-dene-hai').innerText = `₹${totalDene.toLocaleString()}`;
            
            if(noMsg) count === 0 ? noMsg.classList.remove('hidden') : noMsg.classList.add('hidden');
        }

        // OPEN LEDGER
        function openPersonDetails(name) {
            lastOpenedPerson = name;
            const modal = document.getElementById('person-history-modal');
            const list = document.getElementById('ph-content');
            
            document.getElementById('ph-name').innerText = name;
            const bal = calculateBalance(name);
            
            // Find phone
            const personTx = transactions.filter(t => t.person === name);
            const lastTx = personTx.find(t => t.phone) || {};
            document.getElementById('ph-phone').innerText = lastTx.phone || "No Phone";

            // Configure Header Buttons (Reminder / Settle)
            const btnReminder = document.getElementById('btn-ledger-reminder');
            btnReminder.onclick = () => {
                const clean = (lastTx.phone || '').replace(/\D/g, '');
                const ph = clean.length === 10 ? '91'+clean : clean;
                if(!ph) return alert("No phone number found.");
                const txt = `Dear ${name}, Your total pending balance is ${formatter.format(Math.abs(bal))}. Please clear it soon.`;
                window.open(`https://wa.me/${ph}?text=${encodeURIComponent(txt)}`, '_blank');
            };

            const btnSettle = document.getElementById('btn-ledger-settle');
            btnSettle.onclick = () => openWusoolForPerson(name, true);

            // Configure Footer Buttons (Give / Take)
            document.getElementById('btn-ledger-give').onclick = () => {
                document.getElementById('person-history-modal').classList.add('hidden');
                openNewUdharModal();
                document.getElementById('udhar-person').value = name;
                if(lastTx.phone) document.getElementById('udhar-phone').value = lastTx.phone;
                setLoanType('given'); // Default: I GAVE
            };
            
            document.getElementById('btn-ledger-get').onclick = () => {
                document.getElementById('person-history-modal').classList.add('hidden');
                openNewUdharModal();
                document.getElementById('udhar-person').value = name;
                if(lastTx.phone) document.getElementById('udhar-phone').value = lastTx.phone;
                setLoanType('taken'); // Default: I GOT
            };

            list.innerHTML = '';
            // Sort by date desc
            const history = personTx.sort((a,b) => new Date(b.date) - new Date(a.date) || b.id - a.id);
            
            history.forEach(t => {
                // Card Style Entry
                const isGiven = (t.type === 'udhar' && t.loanType === 'given') || (t.isWusool && t.type === 'expense');
                
                let amountColor = isGiven ? 'text-rose-600' : 'text-emerald-600';
                let typeLabel = isGiven ? 'YOU GAVE 🔴' : 'YOU GOT 🟢';
                let bgClass = isGiven ? 'bg-rose-50 border-rose-100' : 'bg-emerald-50 border-emerald-100';

                const item = document.createElement('div');
                item.className = `p-3 mb-2 rounded-xl border ${bgClass} flex justify-between items-center`;
                item.innerHTML = `
                    <div>
                        <p class="text-[10px] text-slate-400 font-bold mb-0.5">${t.date}</p>
                        <p class="font-bold text-slate-700 text-xs">${t.desc}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold ${amountColor} text-sm">₹${t.amount.toLocaleString()}</p>
                        <p class="text-[9px] ${amountColor} font-bold opacity-80">${typeLabel}</p>
                    </div>
                `;
                list.appendChild(item);
            });
            
            modal.classList.remove('hidden');
        }

        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Helper to avoid Unicode Rupee symbol in PDF which breaks standard fonts
            const formatMoney = (amount) => "Rs. " + amount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            
            // -- Header Styling (Teal Background) --
            doc.setFillColor(13, 148, 136); // Teal-600
            doc.rect(0, 0, 210, 40, 'F');
            
            // Title
            doc.setTextColor(255, 255, 255);
            doc.setFont("helvetica", "bold");
            doc.setFontSize(22);
            doc.text("Madani Exp Tracker", 14, 18);
            
            // Subtitle
            doc.setFont("helvetica", "normal");
            doc.setFontSize(10);
            doc.text("Account Statement", 14, 25);
            doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 30);

            // -- Summary Section (Like App Header) --
            // SORTING CHANGE: Date Descending, then ID Descending (Newest Entry Top in PDF too)
            const data = getFilteredTransactions().sort((a,b) => new Date(b.date) - new Date(a.date) || b.id - a.id);
            
            // Calculate totals based on filtered view
            let totalInc = 0, totalExp = 0;
            data.forEach(t => {
                if(t.type === 'income' || (t.type === 'udhar' && t.loanType === 'taken')) totalInc += t.amount;
                if(t.type === 'expense' || (t.type === 'udhar' && t.loanType === 'given')) totalExp += t.amount;
            });
            const net = totalInc - totalExp;

            // Draw Summary Box
            doc.setFillColor(248, 250, 252); // Slate-50
            doc.setDrawColor(226, 232, 240); // Slate-200
            doc.roundedRect(14, 45, 182, 25, 3, 3, 'FD');

            doc.setTextColor(100, 116, 139); // Slate-500
            doc.setFontSize(8);
            doc.text("TOTAL INCOME", 24, 53);
            doc.text("TOTAL EXPENSE", 84, 53);
            doc.text("NET BALANCE", 144, 53);

            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(16, 185, 129); // Emerald
            doc.text(formatMoney(totalInc), 24, 62);
            
            doc.setTextColor(225, 29, 72); // Rose
            doc.text(formatMoney(totalExp), 84, 62);
            
            doc.setTextColor(net >= 0 ? 16 : 225, net >= 0 ? 185 : 29, net >= 0 ? 129 : 72); // Conditional Color
            doc.text(formatMoney(net), 144, 62);

            // -- Table Section --
            const balances = getRunningBalances();
            
            // Removed Time Column, Merged Date & Time
            const tableColumn = ["Date", "Category", "Details", "Mode", "Amount", "Balance"];
            const tableRows = [];

            data.forEach(t => {
                const bal = balances[t.id] !== undefined ? formatMoney(balances[t.id]) : '-';
                const timeStr = new Date(t.id).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                
                // Format Amount with +/- sign
                let amtStr = formatMoney(t.amount);
                if(t.type === 'income' || (t.type === 'udhar' && t.loanType === 'taken')) {
                    amtStr = "+ " + amtStr;
                } else {
                    amtStr = "- " + amtStr;
                }

                const row = [
                    t.date + "\n" + timeStr, // Date & Time Combined
                    t.desc + (t.person ? ` (${t.person})` : ''), // Category / Main Title
                    t.note || '-', // Description / User Note
                    t.account,
                    amtStr,
                    bal
                ];
                tableRows.push(row);
            });

            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 80,
                theme: 'grid',
                styles: { 
                    fontSize: 9, 
                    cellPadding: 3,
                    font: "helvetica",
                    textColor: [51, 65, 85], // Slate-700
                    valign: 'middle'
                },
                headStyles: { 
                    fillColor: [13, 148, 136], // Teal-600
                    textColor: [255, 255, 255],
                    fontStyle: 'bold'
                },
                columnStyles: {
                    0: { cellWidth: 25 }, // Date (Slightly wider for Time)
                    1: { cellWidth: 30 }, // Category
                    2: { cellWidth: 'auto' }, // Details (Dynamic width)
                    3: { cellWidth: 15 }, // Mode
                    4: { cellWidth: 25, halign: 'right', fontStyle: 'bold' }, // Amount
                    5: { cellWidth: 25, halign: 'right', fontStyle: 'bold', textColor: [100, 116, 139] } // Balance
                },
                didParseCell: function(data) {
                    // Color code the Amount column
                    if (data.section === 'body' && data.column.index === 4) { // Amount is now at index 4
                        const text = data.cell.raw;
                        if (text.startsWith('+')) {
                            data.cell.styles.textColor = [16, 185, 129]; // Green
                        } else {
                            data.cell.styles.textColor = [225, 29, 72]; // Red
                        }
                    }
                }
            });
            
            doc.save(`Exp_Tracker_${Date.now()}.pdf`);
        }

        // --- INITIALIZATION ---
        window.onload = function() {
            setupDates();
            initFilterUI();
            if(document.getElementById('budget-cat-select')) populateBudgetCatSelect();
            switchView('home');
            calculateBudget();
            updateUI();
        };
    </script>
</body>
</html>
